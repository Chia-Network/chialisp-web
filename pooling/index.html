<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-primitives/pooling" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Pooling | Chialisp</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chialisp.com/pooling/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Pooling | Chialisp"><meta data-rh="true" name="description" content="The way that Chia Network does pooling is unlike many blockchains that have come before it. Pool operators actually rely on an on-chain smart coin to verify that they will be able to directly claim any potential pool rewards that farmers create."><meta data-rh="true" property="og:description" content="The way that Chia Network does pooling is unlike many blockchains that have come before it. Pool operators actually rely on an on-chain smart coin to verify that they will be able to directly claim any potential pool rewards that farmers create."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chialisp.com/pooling/"><link data-rh="true" rel="alternate" href="https://chialisp.com/pooling/" hreflang="en"><link data-rh="true" rel="alternate" href="https://chialisp.com/pooling/" hreflang="x-default"><script src="/js/matomo.js" async defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.32ff87a6.css">
<script src="/assets/js/runtime~main.855c602b.js" defer="defer"></script>
<script src="/assets/js/main.86a53bdf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Chialisp</b></a><a href="https://docs.chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://docs.chia.net/academy-home/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia Academy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia.net<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/Chia-Network/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/chialisp-primer/">Chialisp Primer</a><button aria-label="Expand sidebar category &#x27;Chialisp Primer&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/chialisp-concepts/">Chialisp Concepts</a><button aria-label="Expand sidebar category &#x27;Chialisp Concepts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/commands/">Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/syntax/">Syntax</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/modern-chialisp/">Modern Chialisp</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operators/">Operators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/examples/">Examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/costs/">Costs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/conditions/">Conditions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/optimization/">Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/common_issues/">Common Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/debugging/">Debugging</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/standard-transactions/">Primitives</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/standard-transactions/">Standard Transactions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/singletons/">Singletons</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cats/">CATs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/nfts/">NFTs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/dids/">DIDs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/offers/">Offers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/pooling/">Pooling</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/clvm/">CLVM</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Primitives</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Pooling</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Pooling</h1></header><p>The way that Chia Network does pooling is unlike many blockchains that have come before it. Pool operators actually rely on an on-chain smart coin to verify that they will be able to directly claim any potential pool rewards that farmers create.
This allows pools to trust farmers enough to pay them out, while still keeping the power of making the blocks in the hands of the farmer.
This means that the decentralization of the network remains the same, even as the rewards get concentrated to the pool!</p>
<p>In this section, we&#x27;re going to break down how all of this works in Chialisp.
This section assumes you have already read the section about <a href="/singletons/">singletons</a> (or at least understand how they work) as that is the outer puzzle that wraps the pooling puzzles.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="design-requirements">Design Requirements<a href="#design-requirements" class="hash-link" aria-label="Direct link to Design Requirements" title="Direct link to Design Requirements">​</a></h2>
<p>There are a few requirements that were set for how the pooling protocol would work on the Chia Network. Let&#x27;s go over them now:</p>
<ul>
<li><strong>The farmer farms the blocks, not the pool.</strong> This is incredibly important for network decentralization. If this is not true, then the bigger a pool gets, the closer it is to gaining 51% of the network resources.
We still want the farmers to create the blocks, but we need some way to assure the pool that the farmer will give them the reward when they do.
We do this by creating plots that farm directly to a specific puzzle hash, and ensuring that puzzle hash is something that the pool can claim.</li>
<li><strong>The farmer must be able to change pools.</strong> Initially, this seems to conflict with the first requirement.
Plots can be made to send rewards directly to a puzzle hash, but you cannot change that puzzle hash once they are plotted.
If you want to switch pools, you&#x27;ll have to remake all of your plots! We solve this by having our plots create payments that a specific singleton (also called a &quot;plot nft&quot;) can claim.
Then, we can lend partial control of that singleton to a pool, but still retain the ability to reclaim our singleton and lend it instead to a different pool.
Our plots will remain effective as long as we retain control of the singleton.</li>
<li><strong>The farmer cannot leave the pool immediately.</strong> This requirement prevents attacks common to other blockchains where a miner will send partials to a pool until they win a block, then leave the pool immediately and claim that block for themselves.
To prevent this, we have implemented something called a <strong>waiting room</strong> puzzle which is nearly the same as the puzzle for farming to a pool, except that the farmer can reclaim their singleton after a specified amount of time (in blocks).</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-pool-member">The Pool Member<a href="#the-pool-member" class="hash-link" aria-label="Direct link to The Pool Member" title="Direct link to The Pool Member">​</a></h2>
<p>We call the standard puzzle that we use to lend away partial control of our singleton the <strong>pool member</strong> inner puzzle.
Our goal here is threefold:</p>
<ul>
<li>Allow the pool to claim <a href="/singletons/#pay-to-singleton">pay-to-singleton coins</a></li>
<li>Disallow the farmer from claiming any coins</li>
<li>Allow the farmer to begin the process of reclaiming full control of the singleton</li>
</ul>
<p>Let&#x27;s take a look at the full source now:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       POOL_PUZZLE_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       P2_SINGLETON_PUZZLE_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       OWNER_PUBKEY</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       POOL_REWARD_PREFIX</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       WAITINGROOM_PUZHASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       p1</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       pool_reward_height</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; POOL_PUZZLE_HASH is commitment to the pool&#x27;s puzzle hash</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; P2_SINGLETON_PUZZLE_HASH is the puzzle hash for your pay to singleton puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; OWNER_PUBKEY is the farmer pubkey which authorises a travel</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; POOL_REWARD_PREFIX is network-specific data (mainnet vs testnet) that helps determine if a coin is a pool reward</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; WAITINGROOM_PUZHASH is the puzzle_hash you&#x27;ll go to when you iniate the leaving process</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; Absorbing money if pool_reward_height is an atom</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; Escaping if pool_reward_height is ()</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; p1 is pool_reward_amount if absorbing money</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; p1 is key_value_list if escaping</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; pool_reward_amount is the value of the coin reward - this is passed in so that this puzzle will still work after halvenings</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; pool_reward_height is the block height that the reward was generated at. This is used to calculate the coin ID.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; key_value_list is signed extra data that the wallet may want to publicly announce for syncing purposes</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (include condition_codes.clib)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (include singleton_truths.clib)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; takes a lisp tree and returns the hash of it</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun sha256tree (TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (if (l TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (sha256 2 (sha256tree (f TREE)) (sha256tree (r TREE)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (sha256 1 TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun-inline calculate_pool_reward (pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX pool_reward_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (sha256 (logior POOL_REWARD_PREFIX (logand (- (lsh (q . 1) (q . 128)) (q . 1)) pool_reward_height)) P2_SINGLETON_PUZZLE_HASH pool_reward_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun absorb_pool_reward (POOL_PUZZLE_HASH my_inner_puzzle_hash my_amount pool_reward_amount pool_reward_id)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (list</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN my_inner_puzzle_hash my_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN POOL_PUZZLE_HASH pool_reward_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_PUZZLE_ANNOUNCEMENT pool_reward_id)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list ASSERT_COIN_ANNOUNCEMENT (sha256 pool_reward_id &#x27;$&#x27;))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun-inline travel_to_waitingroom (OWNER_PUBKEY WAITINGROOM_PUZHASH my_amount extra_data)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (list (list AGG_SIG_ME OWNER_PUBKEY (sha256tree extra_data))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (list CREATE_COIN WAITINGROOM_PUZHASH my_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; main</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (if pool_reward_height</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (absorb_pool_reward POOL_PUZZLE_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (my_inner_puzzle_hash_truth Truths)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (my_amount_truth Truths)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        p1</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (calculate_pool_reward pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX p1)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (travel_to_waitingroom OWNER_PUBKEY WAITINGROOM_PUZHASH (my_amount_truth Truths) p1)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As always, let&#x27;s begin with the arguments:</p>
<p><code>POOL_PUZZLE_HASH</code> is the address to which we want to pay the pool when we win a block reward.
The pool uses this to verify that the singleton has been lent to them.</p>
<p><code>P2_SINGLETON_PUZZLE_HASH</code> is the puzzle hash that payments to this singleton will have.
This is the hash that farmers make their plots to.</p>
<p><code>OWNER_PUBKEY</code> is the public key that will sign the decision to leave the pool.
This is likely owned by the farmer.</p>
<p><code>POOL_REWARD_PREFIX</code> is a bit of a unique argument.
On the chia mainnet, this will always be <code>ccd5bb71183532bff220ba46c268991a00000000000000000000000000000000</code>.
It is the beginning of the <code>parent_coin_id</code> of pool reward coins. Because those coins do not have a parent, their ID is derived from a combination of the network ID in the left half of the ID, and an incrementing identifier in the right.
That first half is followed by 32 zeroes to make it the length of a standard hash.
We&#x27;ll talk more about why this is needed when we go over the segment of code that uses it.</p>
<p><code>WAITINGROOM_PUZHASH</code> is the puzzle hash of the waiting room puzzle that we will go to when we attempt to leave the pool.
We will go over that puzzle later, but what&#x27;s important to know is that we commit to the puzzle we leave to before we join the pool.
This is so the pool can have certain assurances about how long it will take you to leave.</p>
<p><code>Truths</code> is the data structure that is forcefully added to this puzzle as part of the singleton top layer.
It contains some data we will use in the puzzle which we will access by using some functions from the <code>singleton_truths.clib</code> library.</p>
<p>There are two spend cases for this puzzle.
The <strong>absorb case</strong> will most likely be triggered by the pool and is how they claim the rewards that the farmers receive.
The <strong>escape case</strong> will be initiated by the farmer to begin the process of leaving the pool by heading to the waiting room.
The following two arguments change depending on the case we are executing:</p>
<p><code>p1</code> is named the way it is because it is going to be different depending on the spend type we are using.
It is either:</p>
<ul>
<li>The amount of the pool reward that is being claimed (1750000000000 during the first three years)</li>
<li>A list of key value pairs that is used to reveal important information to the blockchain for wallets to use (similar to the <a href="/singletons/#launcher">singleton launcher</a>)</li>
</ul>
<p><code>pool_reward_height</code> is also different depending on the spend case, but in the escape case it is just <code>()</code> so we leave it named the way it is.
In the absorb case, it is the height of the pool reward that is being absorbed.
This is used along with <code>POOL_REWARD_PREFIX</code> to calculate the <code>parent_coin_id</code> of the reward coin so that we can calculate its ID.</p>
<p>Let&#x27;s talk about our main entry point:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(if pool_reward_height</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (absorb_pool_reward POOL_PUZZLE_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                      (my_inner_puzzle_hash_truth Truths)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                      (my_amount_truth Truths)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                      p1</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                      (calculate_pool_reward pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX p1)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (travel_to_waitingroom OWNER_PUBKEY WAITINGROOM_PUZHASH (my_amount_truth Truths) p1)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The main control flow here is whether or not the height is passed in as <code>()</code>. This is how we determine the spend type to execute. After that we just head to the appropriate function that generates the conditions we will need for the type of spend we are executing. You&#x27;ll notice that we are extracting the relevant data from the <code>Truths</code> object before we pass them to the inner functions.</p>
<p>We are also calculating one additional piece of information.
Let&#x27;s look at it now:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun-inline calculate_pool_reward (pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX pool_reward_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (sha256 (logior POOL_REWARD_PREFIX (logand (- (lsh (q . 1) (q . 128)) (q . 1)) pool_reward_height)) P2_SINGLETON_PUZZLE_HASH pool_reward_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This line may look complex, but it&#x27;s doing something fairly simplistic.
It is calculating the coin ID of the reward coin it is claiming by manually calculating the parent id from the <code>POOL_REWARD_PREFIX</code> and <code>pool_reward_height</code>.</p>
<p>Why do we have to do this? The manual calculation is due to the fact that this singleton may have other payments made to it.
Right now, since we are lending our singleton to the pool, we don&#x27;t want the singleton to be able to claim those rewards. We specifically only want the pool to be able to claim pool rewards that are generated from farming.
Since we know these rewards have a <code>parent_coin_id</code> that is a special format, we can manually calculate it to ensure that the pool can&#x27;t lie to us and pass in the ID of a non-reward coin.</p>
<p>Let&#x27;s take a look at this section here:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(logior POOL_REWARD_PREFIX (logand (- (lsh (q . 1) (q . 128)) (q . 1)) pool_reward_height))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>(- (lsh (q . 1) (q . 128)) (q . 1))</code> is simply a way of generating a sequence of 32 <code>f</code>s. We then use <code>logand</code> on that with the pool reward height, which in an honest scenario should leave it unchanged.
Finally, we use <code>logior</code> to combine the two values into one string.
Let&#x27;s say we have a height of <code>abcdef</code>.
Our final product will be <code>ccd5bb71183532bff220ba46c268991a00000000000000000000000000abcdef</code>.</p>
<p>Why do we need this extra <code>logand</code> with the string of <code>f</code>s? It&#x27;s to prevent a relatively obscure, but possible attack.
Remember that an attacker can pass whatever they want in through the solution.
For example, a 32 byte hex string.
If they passed through the right hex string, they could completely control the output of our calculation <em>except</em> for the bits that happen to be set to 1 in the genesis challenge half of the <code>POOL_REWARD_PREFIX</code> (62/128 of them).
The idea is that a pool could grind out a coin whose parent ID has all of those bits set, create the coin, and then use the singleton to claim it.
Why claim a coin that you already had control of? This will become more apparent in the waiting room puzzle, but they could hypothetically &quot;freeze&quot; the singleton in their pool if they were able to reset the puzzle.
It&#x27;s not as important in the pool member puzzle, but it is still probably best to prevent the pool from spending the singleton in an unintended way.
The <code>logand</code> ensures that only bits on the right can change, every bit on left gets set to 0 before it is evaluated with the <code>logior</code>.</p>
<p>Okay let&#x27;s move onto the conditions for the absorb spend case:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun absorb_pool_reward (POOL_PUZZLE_HASH my_inner_puzzle_hash my_amount pool_reward_amount pool_reward_id)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (list</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (list CREATE_COIN my_inner_puzzle_hash my_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (list CREATE_COIN POOL_PUZZLE_HASH pool_reward_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (list CREATE_PUZZLE_ANNOUNCEMENT pool_reward_id)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (list ASSERT_COIN_ANNOUNCEMENT (sha256 pool_reward_id &#x27;$&#x27;))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The first <code>CREATE_COIN</code> condition ensures that our singleton is recreated exactly as it is. Remember that we get <code>my_inner_puzzle_hash</code> and <code>my_amount</code> from our singleton outer puzzle, so we don&#x27;t need to assert them.</p>
<p>The next <code>CREATE_COIN</code> condition creates the coin that uses the excess value from spending the pay-to-singleton coin to pay the pool.
Keep in mind that this puzzle hash is curried into the puzzle and cannot change.
This is because there is no signature required from the pool to spend the coin.
If we didn&#x27;t pre-commit to the puzzle hash, anyone could solve with their own puzzle hash and spend the rewards to themselves.</p>
<p>The announcement conditions are the other side of the <a href="/singletons/#pay-to-singleton">pay-to-singleton announcements</a>. The announcement creation allows the pay-to-singleton to assert that it has received the instruction to pay out.
The announcement assertion ensures that the pay-to-singleton is actually spent (otherwise we run into the singleton &quot;freezing&quot; problem from above again).</p>
<p>Finally, let&#x27;s look at the escape conditions:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun-inline travel_to_waitingroom (OWNER_PUBKEY WAITINGROOM_PUZHASH my_amount extra_data)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (list (list AGG_SIG_ME OWNER_PUBKEY (sha256tree extra_data))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN WAITINGROOM_PUZHASH my_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Simple enough. We first require a signature on the key/value list that is being passed in through the solution to secure it and to signal that this spend is indeed triggered by the owner of the singleton. The only other thing we do is send ourselves to the waiting room.</p>
<p>Let&#x27;s talk about that puzzle now.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-waiting-room">The Waiting Room<a href="#the-waiting-room" class="hash-link" aria-label="Direct link to The Waiting Room" title="Direct link to The Waiting Room">​</a></h2>
<p>Before we start talking about this puzzle, let&#x27;s examine the full source as usual:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        POOL_PUZZLE_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        P2_SINGLETON_PUZZLE_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        OWNER_PUBKEY</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        POOL_REWARD_PREFIX</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        RELATIVE_LOCK_HEIGHT</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        spend_type</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        p1</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        p2</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; POOL_PUZZLE_HASH is commitment to the pool&#x27;s puzzle hash</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; P2_SINGLETON_PUZZLE_HASH is the puzzlehash for your pay_to_singleton puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; OWNER_PUBKEY is the farmer pubkey which signs the exit puzzle_hash</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; POOL_REWARD_PREFIX is network-specific data (mainnet vs testnet) that helps determine if a coin is a pool reward</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; RELATIVE_LOCK_HEIGHT is how long it takes to leave</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; spend_type is: 0 for absorbing money, 1 to escape</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; if spend_type is 0</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; p1 is pool_reward_amount - the value of the coin reward - this is passed in so that this puzzle will still work after halvenings</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; p2 is pool_reward_height - the block height that the reward was generated at. This is used to calculate the coin ID.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; if spend_type is 1</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; p1 is key_value_list - signed extra data that the wallet may want to publicly announce for syncing purposes</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; p2 is destination_puzhash - the location that the escape spend wants to create itself to</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (include condition_codes.clvm)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (include singleton_truths.clib)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; takes a lisp tree and returns the hash of it</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun sha256tree (TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (if (l TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (sha256 2 (sha256tree (f TREE)) (sha256tree (r TREE)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (sha256 1 TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun-inline calculate_pool_reward (pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX pool_reward_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (sha256 (logior POOL_REWARD_PREFIX (logand (- (lsh (q . 1) (q . 128)) (q . 1)) pool_reward_height)) P2_SINGLETON_PUZZLE_HASH pool_reward_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun absorb_pool_reward (POOL_PUZZLE_HASH my_inner_puzzle_hash my_amount pool_reward_amount pool_reward_id)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (list</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN my_inner_puzzle_hash my_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN POOL_PUZZLE_HASH pool_reward_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_PUZZLE_ANNOUNCEMENT pool_reward_id)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list ASSERT_COIN_ANNOUNCEMENT (sha256 pool_reward_id &#x27;$&#x27;))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun-inline travel_spend (RELATIVE_LOCK_HEIGHT new_puzzle_hash my_amount extra_data)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (list (list ASSERT_HEIGHT_RELATIVE RELATIVE_LOCK_HEIGHT)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (list CREATE_COIN new_puzzle_hash my_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (list AGG_SIG_ME OWNER_PUBKEY (sha256tree (list new_puzzle_hash extra_data)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; main</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (if spend_type</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (travel_spend RELATIVE_LOCK_HEIGHT p2 (my_amount_truth Truths) p1)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (absorb_pool_reward POOL_PUZZLE_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (my_inner_puzzle_hash_truth Truths)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (my_amount_truth Truths)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        p1</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (calculate_pool_reward p2 P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX p1)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You may notice that is looks nearly identical to the one above.
Instead of breaking this down piece by piece, we&#x27;re just going to focus on the differences.
First, the parameters:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  POOL_PUZZLE_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  P2_SINGLETON_PUZZLE_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  OWNER_PUBKEY</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  POOL_REWARD_PREFIX</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  RELATIVE_LOCK_HEIGHT</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  spend_type</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  p1</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  p2</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We still have <code>POOL_PUZZLE_HASH</code>, <code>P2_SINGLETON_PUZZLE_HASH</code>, <code>OWNER_PUBKEY</code>, and <code>POOL_REWARD_PREFIX</code>.
However, now we also have a new curried in parameter called <code>RELATIVE_LOCK_HEIGHT</code>. This indicates the amount of time after entering this waiting room that we have to wait before we can spend away to something else.</p>
<p>Note that relative lock heights are calculated from the time of the coin&#x27;s creation.
If the coin is spent as part of an absorb, this lock height resets.
Theoretically, with a large enough lock height and a big enough farmer who wins frequently, this singleton can be &quot;frozen&quot; until the farmer is lucky enough not to win a block within the specified timeframe.</p>
<p>We still have <code>Truths</code>, since this is still a singleton inner puzzle.
However, the final three arguments are almost completely different.</p>
<p><code>spend_type</code> is now necessary because we can no longer choose which spend case we are executing based on the last argument.</p>
<p><code>p1</code> is different based on the spend type:</p>
<ul>
<li>If we&#x27;re doing the absorb spend, it&#x27;s the amount of the pool reward coin.</li>
<li>If we&#x27;re traveling to a new puzzle, it&#x27;s the key/value list that we use to record data in the blockchain.</li>
</ul>
<p><code>p2</code> is also different based on the spend type:</p>
<ul>
<li>If we&#x27;re doing the absorb spend, it&#x27;s the height at which the pool reward coin was created.</li>
<li>If we&#x27;re traveling to a new puzzle, it&#x27;s the puzzle hash of that puzzle</li>
</ul>
<p>After the argument differences, the only other major change is in the travel function:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun-inline travel_spend (RELATIVE_LOCK_HEIGHT new_puzzle_hash my_amount extra_data)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (list (list ASSERT_HEIGHT_RELATIVE RELATIVE_LOCK_HEIGHT)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN new_puzzle_hash my_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list AGG_SIG_ME OWNER_PUBKEY (sha256tree (list new_puzzle_hash extra_data)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>First, we assert that the required amount of time has passed (this is for the pool&#x27;s safety).
Then, we create the new specified coin.
Note that we don&#x27;t get to choose the amount and, therefore, must escape to a new singleton.</p>
<p>Finally, we sign the extra data, just like before, but this time we include the <code>destination_puzhash</code> so that someone malicious cannot steal our singleton by substituting in a value.</p>
<p>Those are the only changes!</p>
<p>It may seem pretty irregular to have these as separate but similar puzzles.
There&#x27;s a lot of code duplication which is usually bad practice.
It&#x27;s very possible that there is a way to combine these two puzzles into a single puzzle, but the cost would increase dramatically.
At the end of the day, it&#x27;s better to have duplicated code than to bog down the blockchain with needlessly expensive transactions.</p>
<p>Interestingly enough, we actually want to be in the waiting room state with a lock height of zero when we are pooling by ourselves.
The reasoning is that since we are &quot;lending&quot; the singleton to ourselves, we don&#x27;t really need the insurance that we leave early, which is the entire point of the waiting room.
This cuts down on unnecessary spends, and saves us even more cost in the long run.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Chia-Network/chialisp-web/blob/main/docs/primitives/pooling.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/offers/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Offers</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/clvm/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CLVM</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#design-requirements" class="table-of-contents__link toc-highlight">Design Requirements</a></li><li><a href="#the-pool-member" class="table-of-contents__link toc-highlight">The Pool Member</a></li><li><a href="#the-waiting-room" class="table-of-contents__link toc-highlight">The Waiting Room</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/operators/">Operators</a></li><li class="footer__item"><a class="footer__link-item" href="/clvm/">CLVM</a></li><li class="footer__item"><a href="https://docs.chia.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chia Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/chia" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/chia_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.chia.net/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/Chia-Network/clvm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">© 2025 Chia Network Inc., Licensed under the <a href="https://github.com/Chia-Network/chialisp-web/blob/main/LICENSE" target="_blank">Apache License, Version 2.0</a> | <a href="https://www.chia.net/terms">Terms</a></div></div></div></footer></div>
</body>
</html>