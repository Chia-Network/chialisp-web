<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-primitives/cats" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">CATs | Chialisp</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chialisp.com/cats/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="CATs | Chialisp"><meta data-rh="true" name="description" content="Chia Asset Tokens are fungible tokens that are issued on the Chia blockchain. The CAT puzzle ensures that the supply of a specific CAT never changes unless the rules of issuance specific to that CAT are followed. These are enforced using a separate Chialisp program called the Token and Asset Issuance Limitations (TAIL)."><meta data-rh="true" property="og:description" content="Chia Asset Tokens are fungible tokens that are issued on the Chia blockchain. The CAT puzzle ensures that the supply of a specific CAT never changes unless the rules of issuance specific to that CAT are followed. These are enforced using a separate Chialisp program called the Token and Asset Issuance Limitations (TAIL)."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chialisp.com/cats/"><link data-rh="true" rel="alternate" href="https://chialisp.com/cats/" hreflang="en"><link data-rh="true" rel="alternate" href="https://chialisp.com/cats/" hreflang="x-default"><script src="/js/matomo.js" async defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.0c5a5a7d.css">
<script src="/assets/js/runtime~main.c11d0f02.js" defer="defer"></script>
<script src="/assets/js/main.e3544e1b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Chialisp</b></a><a href="https://docs.chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://docs.chia.net/academy-home/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia Academy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia.net<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/Chia-Network/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/chialisp-primer/">Chialisp Primer</a><button aria-label="Expand sidebar category &#x27;Chialisp Primer&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/chialisp-concepts/">Chialisp Concepts</a><button aria-label="Expand sidebar category &#x27;Chialisp Concepts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/commands/">Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/syntax/">Syntax</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/modern-chialisp/">Modern Chialisp</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operators/">Operators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/examples/">Examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/costs/">Costs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/conditions/">Conditions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/optimization/">Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/common_issues/">Common Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/debugging/">Debugging</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/standard-transactions/">Primitives</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/standard-transactions/">Standard Transactions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/singletons/">Singletons</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cats/">CATs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/nfts/">NFTs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/dids/">DIDs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/offers/">Offers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pooling/">Pooling</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/clvm/">CLVM</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Primitives</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">CATs</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>CATs</h1></header><p>Chia Asset Tokens are fungible tokens that are issued on the Chia blockchain. The CAT puzzle ensures that the supply of a specific CAT never changes unless the rules of issuance specific to that CAT are followed. These are enforced using a separate Chialisp program called the <a href="#tail">Token and Asset Issuance Limitations (TAIL)</a>.</p>
<p>Aside from the TAIL, there is also an <a href="/chialisp-inner-puzzles/">inner puzzle</a> that the CAT wraps around. The inner puzzle controls the ownership of the specific coin, and when the coin is spent, the new puzzle is wrapped in the CAT again. Typically, you wrap the <a href="/standard-transactions/">standard transaction</a> so that you can send CATs to Chia wallet addresses.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The first version, known as CAT1, reached its end of life at block 2,311,760 on July 26th, 2022.</p><p>It has been replaced with the current CAT2 standard because of <a href="https://www.chia.net/2022/07/25/upgrading-the-cat-standard.en.html" target="_blank" rel="noopener noreferrer">a vulnerability discovered during a security audit</a>.</p></div></div>
<p>To learn more about the terminology used on this page, check out the <a href="https://www.chia.net/2021/09/23/chia-token-standard-naming.en.html" target="_blank" rel="noopener noreferrer">blog entry explaining CAT naming conventions</a>.</p>
<p>Additionally, fungible tokens can be split apart and merged together, whereas non-fungible tokens are indivisible.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="code-examples">Code Examples<a href="#code-examples" class="hash-link" aria-label="Direct link to Code Examples" title="Direct link to Code Examples">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="chia-blockchain">chia-blockchain<a href="#chia-blockchain" class="hash-link" aria-label="Direct link to chia-blockchain" title="Direct link to chia-blockchain">​</a></h3>
<p>The official Chia wallet has a reference implementation for the following in Python:</p>
<ul>
<li><a href="https://github.com/Chia-Network/chia-blockchain/blob/010cedf83718aa8e4d97da76f892fe69387a5d82/chia/wallet/cat_wallet/cat_wallet.py#L784" target="_blank" rel="noopener noreferrer">Spend CAT coins</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="chia-rs">chia-rs<a href="#chia-rs" class="hash-link" aria-label="Direct link to chia-rs" title="Direct link to chia-rs">​</a></h3>
<p>Wallet code can use the following reference methods:</p>
<ul>
<li><a href="https://github.com/Chia-Network/chia_rs/blob/wallet-dev/chia-primitives/src/primitives/cat.rs" target="_blank" rel="noopener noreferrer">Puzzle and solution types</a></li>
<li><a href="https://github.com/Chia-Network/chia_rs/blob/2334c842f694444da317fa7432f308f159f62d70/chia-wallet/src/wallet.rs#L209" target="_blank" rel="noopener noreferrer">Issue new CAT</a></li>
<li><a href="https://github.com/Chia-Network/chia_rs/blob/2334c842f694444da317fa7432f308f159f62d70/chia-wallet/src/wallet.rs#L545" target="_blank" rel="noopener noreferrer">Spend CAT coins</a></li>
<li><a href="https://github.com/Chia-Network/chia_rs/blob/2334c842f694444da317fa7432f308f159f62d70/chia-wallet/src/wallet.rs#L399" target="_blank" rel="noopener noreferrer">Send CATs to puzzle hash</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="chia-wallet-lib">chia-wallet-lib<a href="#chia-wallet-lib" class="hash-link" aria-label="Direct link to chia-wallet-lib" title="Direct link to chia-wallet-lib">​</a></h3>
<p>The <a href="https://github.com/Chia-Network/node-chia-wallet-lib" target="_blank" rel="noopener noreferrer">Chia wallet library NPM package</a> has the following reference implementation:</p>
<ul>
<li><a href="https://github.com/Chia-Network/node-chia-wallet-lib/blob/6c8d564538be121079596e492fa0da497c9dd39c/src/types/puzzles/AssetToken.ts#L63" target="_blank" rel="noopener noreferrer">Issue new CAT</a></li>
<li><a href="https://github.com/Chia-Network/node-chia-wallet-lib/blob/6c8d564538be121079596e492fa0da497c9dd39c/src/types/puzzles/AssetToken.ts#L102" target="_blank" rel="noopener noreferrer">Spend CAT coins</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="code">CAT Code<a href="#code" class="hash-link" aria-label="Direct link to CAT Code" title="Direct link to CAT Code">​</a></h2>
<p>This is the source code of the CAT, which can also be found in the chia-blockchain repository in the puzzle <a href="https://github.com/Chia-Network/chia-blockchain/blob/fad414132e6950e79e805629427af76bf9ddcbc5/chia/wallet/puzzles/cat_v2.clvm" target="_blank" rel="noopener noreferrer"><code>cat_v2.clvm</code></a>:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand CAT2 puzzle</summary><div><div class="collapsibleContent_i85q"><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockTitle_Ktv7">cat_v2.clvm</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Coins locked with this puzzle are spendable cats.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Choose a list of n inputs (n&gt;=1), I_1, ... I_n with amounts A_1, ... A_n.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; We put them in a ring, so &quot;previous&quot; and &quot;next&quot; have intuitive k-1 and k+1 semantics,</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; wrapping so {n} and 0 are the same, ie. all indices are mod n.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Each coin creates 0 or more coins with total output value O_k.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Let D_k = the &quot;debt&quot; O_k - A_k contribution of coin I_k, ie. how much debt this input accumulates.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Some coins may spend more than they contribute and some may spend less, ie. D_k need</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; not be zero. That&#x27;s okay. It&#x27;s enough for the total of all D_k in the ring to be 0.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; A coin can calculate its own D_k since it can verify A_k (it&#x27;s hashed into the coin id)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; and it can sum up `CREATE_COIN` conditions for O_k.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Defines a &quot;subtotal of debts&quot; S_k for each coin as follows:</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; S_1 = 0</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; S_k = S_{k-1} + D_{k-1}</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Here&#x27;s the main trick that shows the ring sums to 0.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; You can prove by induction that S_{k+1} = D_1 + D_2 + ... + D_k.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; But it&#x27;s a ring, so S_{n+1} is also S_1, which is 0. So D_1 + D_2 + ... + D_k = 0.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; So the total debts must be 0, ie. no coins are created or destroyed.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Each coin&#x27;s solution includes I_{k-1}, I_k, and I_{k+1} along with proofs that I_{k}, and I_{k+1} are CATs of the same type.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Each coin&#x27;s solution includes S_{k-1}. It calculates D_k = O_k - A_k, and then S_k = S_{k-1} + D_{k-1}</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Announcements are used to ensure that each S_k follows the pattern is valid.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Announcements automatically commit to their own coin id.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Coin I_k creates an announcement that further commits to I_{k-1} and S_{k-1}.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Coin I_k gets a proof that I_{k+1} is a cat, so it knows it must also create an announcement</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; when spent. It checks that I_{k+1} creates an announcement committing to I_k and S_k.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; So S_{k+1} is correct iff S_k is correct.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Coins also receive proofs that their neighbours are CATs, ensuring the announcements aren&#x27;t forgeries.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Inner puzzles and the CAT layer prepend `CREATE_COIN_ANNOUNCEMENT` with different prefixes to avoid forgeries.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Ring announcements use 0xcb, and inner puzzles are given 0xca</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; In summary, I_k generates a coin_announcement Y_k (&quot;Y&quot; for &quot;yell&quot;) as follows:</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  Y_k: hash of I_k (automatically), I_{k-1}, S_k</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Each coin creates an assert_coin_announcement to ensure that the next coin&#x27;s announcement is as expected:</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  Y_{k+1} : hash of I_{k+1}, I_k, S_{k+1}</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; TLDR:</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  I_k : coins</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  A_k : amount coin k contributes</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  O_k : amount coin k spend</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  D_k : difference/delta that coin k incurs (A - O)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  S_k : subtotal of debts D_1 + D_2 ... + D_k</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  Y_k : announcements created by coin k commiting to I_{k-1}, I_k, S_k</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; All conditions go through a &quot;transformer&quot; that looks for CREATE_COIN conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; generated by the inner solution, and wraps the puzzle hash ensuring the output is a cat.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Three output conditions are prepended to the list of conditions for each I_k:</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  (ASSERT_MY_ID I_k) to ensure that the passed in value for I_k is correct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  (CREATE_COIN_ANNOUNCEMENT I_{k-1} S_k) to create this coin&#x27;s announcement</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;  (ASSERT_COIN_ANNOUNCEMENT hashed_announcement(Y_{k+1})) to ensure the next coin really is next and</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;     the relative values of S_k and S_{k+1} are correct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; This is all we need to do to ensure cats exactly balance in the inputs and outputs.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; Proof:</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;   Consider n, k, I_k values, O_k values, S_k and A_k as above.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;   For the (CREATE_COIN_ANNOUNCEMENT Y_{k+1}) (created by the next coin)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;   and (ASSERT_COIN_ANNOUNCEMENT hashed(Y_{k+1})) to match,</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;   we see that I_k can ensure that is has the correct value for S_{k+1}.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;   By induction, we see that S_{m+1} = sum(i, 1, m) [O_i - A_i] = sum(i, 1, m) O_i - sum(i, 1, m) A_i</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;   So S_{n+1} = sum(i, 1, n) O_i - sum(i, 1, n) A_i. But S_{n+1} is actually S_1 = 0,</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;   so thus sum(i, 1, n) O_i = sum (i, 1, n) A_i, ie. output total equals input total.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;; GLOSSARY:</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  MOD_HASH: this code&#x27;s sha256 tree hash</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  TAIL_PROGRAM_HASH: the program that determines if a coin can mint new cats, burn cats, and check if its lineage is valid if its parent is not a CAT</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  INNER_PUZZLE: an independent puzzle protecting the coins. Solutions to this puzzle are expected to generate `AGG_SIG` conditions and possibly `CREATE_COIN` conditions.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;; ---- items above are curried into the puzzle hash ----</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  inner_puzzle_solution: the solution to the inner puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  prev_coin_id: the id for the previous coin</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  tail_program_reveal: reveal of TAIL_PROGRAM_HASH required to run the program if desired</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  tail_solution: optional solution passed into tail_program</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  lineage_proof: optional proof that our coin&#x27;s parent is a CAT</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  this_coin_info: (parent_id puzzle_hash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  next_coin_proof: (parent_id inner_puzzle_hash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  prev_subtotal: the subtotal between prev-coin and this-coin</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;  extra_delta: an amount that is added to our delta and checked by the TAIL program</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      MOD_HASH                 ;; curried into puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      TAIL_PROGRAM_HASH        ;; curried into puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      INNER_PUZZLE             ;; curried into puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      inner_puzzle_solution    ;; if invalid, INNER_PUZZLE will fail</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      lineage_proof            ;; This is the parent&#x27;s coin info, used to check if the parent was a CAT. Optional if using tail_program.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      prev_coin_id             ;; used in this coin&#x27;s announcement, prev_coin ASSERT_COIN_ANNOUNCEMENT will fail if wrong</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      this_coin_info           ;; verified with ASSERT_MY_COIN_ID</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      next_coin_proof          ;; used to generate ASSERT_COIN_ANNOUNCEMENT</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      prev_subtotal            ;; included in announcement, prev_coin ASSERT_COIN_ANNOUNCEMENT will fail if wrong</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      extra_delta              ;; this is the &quot;legal discrepancy&quot; between your real delta and what you&#x27;re announcing your delta is</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;;;;; start library code</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (include condition_codes.clvm)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (include curry-and-treehash.clinc)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (include cat_truths.clib)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (include utility_macros.clib)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defconstant RING_MORPH_BYTE 0xcb)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; take two lists and merge them into one</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defun merge_list (list_a list_b)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (if list_a</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (c (f list_a) (merge_list (r list_a) list_b))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        list_b</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; cat_mod_struct = (MOD_HASH MOD_HASH_hash GENESIS_COIN_CHECKER GENESIS_COIN_CHECKER_hash)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defun-inline mod_hash_from_cat_mod_struct (cat_mod_struct) (f cat_mod_struct))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defun-inline mod_hash_hash_from_cat_mod_struct (cat_mod_struct) (f (r cat_mod_struct)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defun-inline tail_program_hash_from_cat_mod_struct (cat_mod_struct) (f (r (r cat_mod_struct))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;;;;; end library code</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; return the puzzle hash for a cat with the given `GENESIS_COIN_CHECKER_hash` &amp; `INNER_PUZZLE`</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline cat_puzzle_hash (cat_mod_struct inner_puzzle_hash)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (puzzle-hash-of-curried-function (mod_hash_from_cat_mod_struct cat_mod_struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                                        inner_puzzle_hash</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                                        (sha256 ONE (tail_program_hash_from_cat_mod_struct cat_mod_struct))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                                        (mod_hash_hash_from_cat_mod_struct cat_mod_struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; assert `CREATE_COIN_ANNOUNCEMENT` doesn&#x27;t contain the RING_MORPH_BYTE bytes so it cannot be used to cheat the coin ring</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline morph_condition (condition cat_mod_struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (if (= (f condition) CREATE_COIN)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         (c CREATE_COIN</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">               (c (cat_puzzle_hash cat_mod_struct (f (r condition)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    (r (r condition)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         (if (= (f condition) CREATE_COIN_ANNOUNCEMENT)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">           (assert (not (and</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                     (= 33 (strlen (f (r condition))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                     (= (substr (f (r condition)) 0 ONE) RING_MORPH_BYTE)  ; lazy eval</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                   ))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">             ; then</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">             condition</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">           )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">           condition</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; given a coin&#x27;s parent, inner_puzzle and amount, and the cat_mod_struct, calculate the id of the coin</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline coin_id_for_proof (coin cat_mod_struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (calculate_coin_id (f coin) (cat_puzzle_hash cat_mod_struct (f (r coin))) (f (r (r coin))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; utility to fetch coin amount from coin</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline input_amount_for_coin (coin)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (f (r (r coin)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; calculate the hash of an announcement</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; we add 0xcb so ring announcements exist in a different namespace to announcements from inner_puzzles</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline calculate_annoucement_id (this_coin_id this_subtotal next_coin_id cat_mod_struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (sha256 next_coin_id RING_MORPH_BYTE (sha256tree (list this_coin_id this_subtotal)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; create the `ASSERT_COIN_ANNOUNCEMENT` condition that ensures the next coin&#x27;s announcement is correct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline create_assert_next_announcement_condition (this_coin_id this_subtotal next_coin_id cat_mod_struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (list ASSERT_COIN_ANNOUNCEMENT</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">             (calculate_annoucement_id this_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                                            this_subtotal</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                                            next_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                                            cat_mod_struct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">             )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; here we commit to I_{k-1} and S_k</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; we add 0xcb so ring announcements exist in a different namespace to announcements from inner_puzzles</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline create_announcement_condition (prev_coin_id prev_subtotal)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (list CREATE_COIN_ANNOUNCEMENT</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">             (concat RING_MORPH_BYTE (sha256tree (list prev_coin_id prev_subtotal)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; this function takes a condition and returns an integer indicating</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; the value of all output coins created with CREATE_COIN. If it&#x27;s not</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; a CREATE_COIN condition, it returns 0.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline output_value_for_condition (condition)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (if (= (f condition) CREATE_COIN)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         (f (r (r condition)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         0</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; add two conditions to the list of morphed conditions:</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; CREATE_COIN_ANNOUNCEMENT for my announcement</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; ASSERT_COIN_ANNOUNCEMENT for the next coin&#x27;s announcement</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline generate_final_output_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         prev_subtotal</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         this_subtotal</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         morphed_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         prev_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         this_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         next_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         cat_mod_struct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         (c (create_announcement_condition prev_coin_id prev_subtotal)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">           (c (create_assert_next_announcement_condition this_coin_id this_subtotal next_coin_id cat_mod_struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">             morphed_conditions)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      ;; This next section of code loops through all of the conditions to do three things:</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      ;;   1) Look for a &quot;magic&quot; value of -113 and, if one exists, filter it, and take note of the tail reveal and solution</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      ;;   2) Morph any CREATE_COIN or CREATE_COIN_ANNOUNCEMENT conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      ;;   3) Sum the total output amount of all of the CREATE_COINs that are output by the inner puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      ;;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      ;; After everything return a struct in the format (morphed_conditions . (output_sum . tail_reveal_and_solution))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      ;; If multiple magic conditions are specified, the later one will take precedence</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (defun-inline condition_tail_reveal (condition) (f (r (r (r condition)))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (defun-inline condition_tail_solution (condition) (f (r (r (r (r condition))))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (defun cons_onto_first_and_add_to_second (morphed_condition output_value struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (c (c morphed_condition (f struct)) (c (+ output_value (f (r struct))) (r (r struct))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (defun find_and_strip_tail_info (inner_conditions cat_mod_struct tail_reveal_and_solution)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (if inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            (if (= (output_value_for_condition (f inner_conditions)) -113)  ; Checks this is a CREATE_COIN of value -113</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                (find_and_strip_tail_info</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  (r inner_conditions)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  cat_mod_struct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  (c (condition_tail_reveal (f inner_conditions)) (condition_tail_solution (f inner_conditions)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                (cons_onto_first_and_add_to_second</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  (morph_condition (f inner_conditions) cat_mod_struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  (output_value_for_condition (f inner_conditions))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  (find_and_strip_tail_info</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    (r inner_conditions)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    cat_mod_struct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    tail_reveal_and_solution</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            (c () (c 0 tail_reveal_and_solution))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;;;;;;;;;;;;;;;;;;;;;;;;;;; lineage checking</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; return true iff parent of `this_coin_info` is provably a cat</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; A &#x27;lineage proof&#x27; consists of (parent_parent_id parent_INNER_puzzle_hash parent_amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; We use this information to construct a coin who&#x27;s puzzle has been wrapped in this MOD and verify that,</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;; once wrapped, it matches our parent coin&#x27;s ID.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun-inline is_parent_cat (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       cat_mod_struct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       parent_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       (= parent_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (calculate_coin_id (f lineage_proof)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  (cat_puzzle_hash cat_mod_struct (f (r lineage_proof)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  (f (r (r lineage_proof)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defun check_lineage_or_run_tail_program</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        this_coin_info</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        tail_reveal_and_solution</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        parent_is_cat  ; flag which says whether or not the parent CAT check ran and passed</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        extra_delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (if tail_reveal_and_solution</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (assert (= (sha256tree (f tail_reveal_and_solution)) (cat_tail_program_hash_truth Truths))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            (merge_list</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              (a  (f tail_reveal_and_solution)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  (list</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    parent_is_cat</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    lineage_proof ; Lineage proof is only guaranteed to be true if parent_is_cat</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    extra_delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                    (r tail_reveal_and_solution)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (assert parent_is_cat (not extra_delta)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     ;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     (defun stager_two (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         (inner_conditions . (output_sum . tail_reveal_and_solution))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         prev_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         this_coin_info</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         next_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         prev_subtotal</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">         extra_delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (check_lineage_or_run_tail_program</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            this_coin_info</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            tail_reveal_and_solution</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            (if lineage_proof (is_parent_cat (cat_struct_truth Truths) (my_parent_cat_truth Truths) lineage_proof) ())</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            extra_delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            (generate_final_output_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              prev_subtotal</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              ; the expression on the next line calculates `this_subtotal` by adding the delta to `prev_subtotal`</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              (+ prev_subtotal (- (input_amount_for_coin this_coin_info) output_sum) extra_delta)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              prev_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              (my_id_cat_truth Truths)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              next_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              (cat_struct_truth Truths)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; CAT TRUTHS struct is: ; CAT Truths is: ((Inner puzzle hash . (MOD hash . (MOD hash hash . TAIL hash))) . (my_id . (my_parent_info my_puzhash my_amount)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; create truths - this_coin_info verified true because we calculated my ID from it!</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; lineage proof is verified later by cat parent check or tail_program</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defun stager (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        cat_mod_struct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        inner_puzzle_hash</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        my_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        prev_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        this_coin_info</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        next_coin_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        prev_subtotal</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        extra_delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (c (list ASSERT_MY_COIN_ID my_id) (stager_two</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (cat_truth_data_to_truth_struct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          inner_puzzle_hash</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          cat_mod_struct</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          my_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          this_coin_info</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (find_and_strip_tail_info inner_conditions cat_mod_struct ())</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        prev_coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        this_coin_info</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (coin_id_for_proof next_coin_proof cat_mod_struct)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        prev_subtotal</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        extra_delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      ))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (stager</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        ;; calculate cat_mod_struct, inner_puzzle_hash, coin_id</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list MOD_HASH (sha256 ONE MOD_HASH) TAIL_PROGRAM_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (a INNER_PUZZLE inner_puzzle_solution)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (sha256tree INNER_PUZZLE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (calculate_coin_id (f this_coin_info) (f (r this_coin_info)) (f (r (r this_coin_info))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        prev_coin_id    ; ID</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        this_coin_info  ; (parent_id puzzle_hash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        next_coin_proof ; (parent_id innerpuzhash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        prev_subtotal</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        extra_delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<p>Additionally, there are a few standard TAIL puzzles.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="single">Single-Issuance TAIL<a href="#single" class="hash-link" aria-label="Direct link to Single-Issuance TAIL" title="Direct link to Single-Issuance TAIL">​</a></h3>
<p>The single-issuance TAIL prevents melting and requires the parent to be a specific coin. This is currently the default way to issue CATs, since it ensures the supply will never increase.</p>
<p>This is the source code, which can also be found in the chia-blockchain repository in the puzzle <a href="https://github.com/Chia-Network/chia-blockchain/blob/fad414132e6950e79e805629427af76bf9ddcbc5/chia/wallet/puzzles/genesis_by_coin_id.clvm" target="_blank" rel="noopener noreferrer"><code>genesis_by_coin_id.clvm</code></a>:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand Genesis By Coin ID puzzle</summary><div><div class="collapsibleContent_i85q"><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockTitle_Ktv7">genesis_by_coin_id.clvm</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; This is a TAIL for use with cat.clvm.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; This checker allows new CATs to be created if they have a particular coin id as parent</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; The genesis_id is curried in, making this lineage_check program unique and giving the CAT it&#x27;s uniqueness</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      GENESIS_ID</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      parent_is_cat</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      _</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (include cat_truths.clib)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (if delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (x)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (if (= (my_parent_cat_truth Truths) GENESIS_ID)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          ()</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (x)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="multi">Multi-Issuance TAIL<a href="#multi" class="hash-link" aria-label="Direct link to Multi-Issuance TAIL" title="Direct link to Multi-Issuance TAIL">​</a></h3>
<p>The multi-issuance TAIL allows any action to be taken, providing the original issuance key is used. Each spend that makes supply changes must be signed separately using this same key.</p>
<p>This is the source code, which can also be found in the chia-blockchain repository in the puzzle <a href="https://github.com/Chia-Network/chia-blockchain/blob/fad414132e6950e79e805629427af76bf9ddcbc5/chia/wallet/puzzles/everything_with_signature.clvm" target="_blank" rel="noopener noreferrer"><code>everything_with_signature.clvm</code></a>:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand Everything With Signature puzzle</summary><div><div class="collapsibleContent_i85q"><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockTitle_Ktv7">everything_with_signature.clvm</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; This is a &quot;limitations_program&quot; for use with cat.clvm.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      PUBKEY</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      parent_is_cat</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      _</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (include condition_codes.clvm)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (list (list AGG_SIG_ME PUBKEY delta)) ; Careful with a delta of zero, the bytecode is 80 not 00</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<p>This TAIL provides a balance between security and flexibility. It&#x27;s similar to the previous TAIL, but the signature can be reused for the puzzle it&#x27;s signed with, allowing the TAIL to change over time. The creator can publish the signature, allowing any owner to run the TAIL on their CAT, but any permissions granted can never be revoked.</p>
<p>This is the source code, which can also be found in the chia-blockchain repository in the puzzle <a href="https://github.com/Chia-Network/chia-blockchain/blob/fad414132e6950e79e805629427af76bf9ddcbc5/chia/wallet/puzzles/delegated_tail.clvm" target="_blank" rel="noopener noreferrer"><code>delegated_tail.clvm</code></a>:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand Delegated TAIL puzzle</summary><div><div class="collapsibleContent_i85q"><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockTitle_Ktv7">delegated_tail.clvm</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; This is a &quot;limitations_program&quot; for use with cat.clvm.</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      PUBKEY</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      Truths</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      parent_is_cat</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      lineage_proof</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      delta</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      inner_conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        delegated_puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        delegated_solution</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (include condition_codes.clvm)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defun sha256tree1 (TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (if (l TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              (sha256 2 (sha256tree1 (f TREE)) (sha256tree1 (r TREE)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              (sha256 1 TREE)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (c (list AGG_SIG_UNSAFE PUBKEY (sha256tree1 delegated_puzzle))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (a delegated_puzzle (c Truths (c parent_is_cat (c lineage_proof (c delta (c inner_conditions delegated_solution))))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="usage">Usage<a href="#usage" class="hash-link" aria-label="Direct link to Usage" title="Direct link to Usage">​</a></h2>
<p>CATs are designed in a way that makes them unusable as regular XCH in spends. However, it is usually possible to melt them back into XCH later. Tokens are often used as a form of credits, such as casino chips or store credit.</p>
<p>TAILs can be used to accommodate issuance requirements, such as:</p>
<table><thead><tr><th>Usage</th><th>Description</th></tr></thead><tbody><tr><td>Stablecoins</td><td>Creator can issue new tokens which are backed by attested funds.</td></tr><tr><td>Limited Supply</td><td>Creator can run a one-time issuance, and no more can ever be issued.</td></tr><tr><td>Asset Redemption</td><td>Creator can allow owners to melt into XCH by following specific rules.</td></tr></tbody></table>
<p>In all of these cases, the TAIL program is run when a coin is spent to check if the issuance is valid.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="design-decisions">Design Decisions<a href="#design-decisions" class="hash-link" aria-label="Direct link to Design Decisions" title="Direct link to Design Decisions">​</a></h2>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="wrapping">Created coins become CATs with the same TAIL<a href="#wrapping" class="hash-link" aria-label="Direct link to Created coins become CATs with the same TAIL" title="Direct link to Created coins become CATs with the same TAIL">​</a></h4>
<p>When the inner puzzle returns a <code>CREATE_COIN</code> condition, it will wrap its puzzle hash with the CAT and curry in the same TAIL as before. This prevents the CAT from being implicitly melted and the value used for other things when spending it.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="accounting">Unless TAIL is revealed, spends must net zero<a href="#accounting" class="hash-link" aria-label="Direct link to Unless TAIL is revealed, spends must net zero" title="Direct link to Unless TAIL is revealed, spends must net zero">​</a></h4>
<p>In order to prevent issuing new CATs or melting existing CATs without the TAIL permitting it, any spend that doesn&#x27;t reveal the TAIL program must output the same amount as the input coins.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="lineage">CATs must match their parent or use the TAIL<a href="#lineage" class="hash-link" aria-label="Direct link to CATs must match their parent or use the TAIL" title="Direct link to CATs must match their parent or use the TAIL">​</a></h4>
<p>Another way to prevent CATs from being issued without permission, is that they validate their lineage by asserting the parent is a CAT of the same TAIL. This is done by using the <code>ASSERT_MY_ID</code> condition to verify the information passed in the spend.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prefixes">CATs enforce prefixes for coin announcements<a href="#prefixes" class="hash-link" aria-label="Direct link to CATs enforce prefixes for coin announcements" title="Direct link to CATs enforce prefixes for coin announcements">​</a></h4>
<p>In order to ensure that the CATs can communicate with each other without interference from an inner puzzle, they must prepend a <code>0xcb</code> prefix to coin announcements that are created within the CAT layer.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="truths">TAILs are given a list of pre-calculated truths<a href="#truths" class="hash-link" aria-label="Direct link to TAILs are given a list of pre-calculated truths" title="Direct link to TAILs are given a list of pre-calculated truths">​</a></h4>
<p>Many TAILs require information that has already been calculated in the CAT layer, so it is bundled together as a pre-validated collection of <code>Truths</code>. These truths are then passed into the TAIL as the first non-curried parameter in the solution. For more info, see <a href="#truth-table">the Truth Table</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hinting">CATs have the option to use hinting<a href="#hinting" class="hash-link" aria-label="Direct link to CATs have the option to use hinting" title="Direct link to CATs have the option to use hinting">​</a></h4>
<p>Hinting is a way to signal the CAT&#x27;s type to a Chia wallet. The hint is typically an inner puzzle hash. For more info, see our <a href="https://docs.chia.net/faq#q-what-is-hinting" target="_blank" rel="noopener noreferrer">explanation of hinting in the FAQ</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="accounting">Spend Accounting<a href="#accounting" class="hash-link" aria-label="Direct link to Spend Accounting" title="Direct link to Spend Accounting">​</a></h2>
<p>Each CAT coin has a truthful calculation of the difference between its amount and its output amount, called its <strong>delta</strong>.</p>
<p>The CAT coins also are given the sum of every other coin&#x27;s deltas, which must be zero. In order to enforce this zero-delta rule, each CAT coin is assigned a next and previous neighbor, which ultimately forms a ring.</p>
<p>The coins use coin announcements to communicate with their neighbors. For this use case, the announcements must contain two pieces of information:</p>
<ul>
<li>The ID of the coin that created this coin. This is already implicitly contained in the coin announcement.</li>
<li>The intended recipient&#x27;s Coin ID. The announcement&#x27;s message must contain this information in order to prevent attacks where coins can receive messages that weren&#x27;t intended for them.</li>
</ul>
<p>To form the ring, every coin outputs the following conditions:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (CREATE_COIN_ANNOUNCEMENT (concat previous_coin_ID sum_of_deltas_before_me))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (ASSERT_COIN_ANNOUNCEMENT (sha256 next_coin_id my_coin_id sum_of_deltas_including_me))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The announcement assertions take the hash of the announcement creator&#x27;s ID and message.</p>
<p>In order to create <code>next_coin_id</code>, the next coin&#x27;s inner puzzle is wrapped with the current coin&#x27;s CAT information. This guarantees that <code>next_coin_id</code> is a CAT of the same type as the current coin.</p>
<p>Because both coins follow the same CAT mod puzzle, they must comply with the same set of truths. This, in turn, guarantees that the whole ring is telling the truth. As long as the ring is connected, the total delta must be zero.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="extra-delta">Extra Delta<a href="#extra-delta" class="hash-link" aria-label="Direct link to Extra Delta" title="Direct link to Extra Delta">​</a></h2>
<p>There are two exceptions to the aforementioned zero-delta rule:</p>
<ul>
<li>Issuing coins (creating CATs from XCH)</li>
<li>Melting coins (turning CATs back into XCH)</li>
</ul>
<p>To account for these cases, the TAIL program may approve a misreporting of a CAT coin&#x27;s Delta by a specific amount, called the <strong>extra delta</strong>. This is one of the parameters passed to the TAIL program.</p>
<p>There are a few rules to ensure that extra coins are not issued or melted:</p>
<ul>
<li>If the extra delta is anything other than <code>0</code>, the TAIL program is forced to run. It must evaluate whether to permit the extra delta, or fail with an <code>(x)</code> call.</li>
<li>If the extra delta value in the solution does not cause the TAIL program to fail, then it is automatically added to the reported delta, which is used in the announcement ring.</li>
<li>If the TAIL program is not revealed and the extra delta is not <code>0</code>, then the spend will fail.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tail">TAIL Program<a href="#tail" class="hash-link" aria-label="Direct link to TAIL Program" title="Direct link to TAIL Program">​</a></h2>
<p>The TAIL program is powerful and flexible. It has control over, and access to, many things. This gives a programmer a lot of control, but also a great deal of responsibility.</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>If the TAIL is programmed incorrectly, the tokens may be issued by attackers, rendering the asset worthless.</p></div></div>
<p>A TAIL should follow all of the conventional rules of security that any Chialisp program responsible for locking up money should follow.</p>
<p>Several parameters must be passed to a TAIL&#x27;s solution:</p>
<table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>Truths</td><td>These are bundled together, as explained in the <a href="#truths">truths section</a>.</td></tr><tr><td>parent_is_cat</td><td>Whether the parent CAT has been validated as the same type.</td></tr><tr><td>lineage_proof (optional)</td><td>Proof that the parent is a CAT of the same type as this CAT.</td></tr><tr><td>delta</td><td>The extra delta value, as explained <a href="#extra-delta">here</a>.</td></tr><tr><td>inner_conditions</td><td>The conditions returned by the inner puzzle (see below).</td></tr><tr><td>tail_solution (optional)</td><td>A list of opaque parameters passed to the TAIL.</td></tr></tbody></table>
<p>Although the TAIL is powerful, it is <em>not necessarily</em> run every time the coin is spent. The TAIL is run if a magic condition is created in the inner puzzle. This magic condition is required to prevent people who can spend the TAIL from intercepting the spend and changing it against the spender&#x27;s will. The magic condition that triggers the TAIL to be run must look like this:</p>
<p><code>(51 0 -113 &lt;TAIL puzzle&gt; &lt;TAIL solution&gt;)</code>, where:</p>
<ul>
<li><code>51</code> is the condition code for <code>CREATE_COIN</code>.</li>
<li><code>0</code> can be replaced with anything, but this is the smallest possible value. Although the <code>CREATE_COIN</code> condition usually has a puzzle hash, it is ignored here.</li>
<li><code>-113</code> is the magic amount, which signals to the CAT layer that the TAIL must be run. A negative number was chosen because negative coins are usually invalid, but otherwise it is an arbitrary amount.</li>
</ul>
<p>The TAIL should check diligently for and authorize or reject the following things:</p>
<ul>
<li>Is the extra delta issuing or melting any coins?</li>
<li>Is this coin&#x27;s parent not a CAT of the same type?</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tail-limitations">Limitations of the TAIL<a href="#tail-limitations" class="hash-link" aria-label="Direct link to Limitations of the TAIL" title="Direct link to Limitations of the TAIL">​</a></h2>
<p>In Ethereum, a token&#x27;s issuer might have the ability to freeze or confiscate funds without the owner&#x27;s permission. This is not possible in Chia.</p>
<p>In Chia, an issuer creates a TAIL, which lives inside all CATs of the same type, including those that have already been distributed. However, the issuer does not have the power to spend coins they do not own. A TAIL can only run as the last step in a CAT&#x27;s spend, and the owner of the CAT (not the issuer) is responsible for providing its solution. This means that only the owner can run the TAIL. Therefore, the CAT&#x27;s owner is the only one with the ability to complete the spend.</p>
<p>This decision adds some decentralization for users. It also adds some complexity. The importance of creating a well-constructed TAIL cannot be emphasized enough. Once a CAT has been distributed, it is no longer possible to change the TAIL across the entire token supply. The TAIL is locked into the same set of rules forever. To change the TAIL would be tantamount to replacing physical cash in circulation. An exchange for new tokens would have to be offered, and the old token eventually deprecated, even if some people still carry it.</p>
<p>It also means that if the set of rules is compromised, people may be able to issue or melt CATs maliciously. There’s no easy way to patch the TAIL, other than through the process above, and therefore it is best avoided.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="valuation">Valuation<a href="#valuation" class="hash-link" aria-label="Direct link to Valuation" title="Direct link to Valuation">​</a></h2>
<p>Some decisions regarding the granularity and denomination of CATs versus XCH:</p>
<ul>
<li>Most Chia wallets choose to display their value in XCH. However, this is a purely cosmetic choice because Chia&#x27;s blockchain only knows about mojos. One XCH is equal to one trillion (1,000,000,000,000) mojos.</li>
<li>In a similar vein, Chia Network has made the design decision to map 1 CAT to 1,000 XCH mojos. This ratio will be the same for all CATs.</li>
<li>Theoretically, it would be possible to set the CAT<!-- -->:mojo<!-- --> ratio to something other than 1:1000 for a specific CAT, but we strongly recommend against doing this. The official Chia wallet will not support CATs with a ratio other than 1:1000. Additionally, if you created your own wallet with support for different ratios, users of this wallet would almost certainly be confused and accidentally spend too much or too little money, by multiple orders of magnitude. Please don&#x27;t attempt this.</li>
<li>The melt value of a single token is 1,000 mojos. This remains true regardless of the token&#x27;s face value or its circulating supply.</li>
<li>A token&#x27;s face value is based on supply and demand, rather than being matched to the melt value.</li>
</ul>
<p>By analogy, on multiple occasions the US Treasury has floated the idea of issuing a $1 trillion coin made from platinum. Leaving aside the practical implications of doing this, the magnitude of the difference between this hypothetical coin&#x27;s face value and melt value would be similar to that of CATs and XCH. The coin would be worth $1 trillion dollars, but if someone melted it and sold the platinum, they&#x27;d only receive a minuscule fraction of that amount.</p>
<p>On the other end of the spectrum, consider the US penny. Its base metals (97.5% zinc and 2.5% copper) are worth around two cents. So in theory, if you could melt a penny into zinc and copper while minimizing your costs, you could sell these metals for a sizable profit.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reasons-for-melting">Reasons for Melting<a href="#reasons-for-melting" class="hash-link" aria-label="Direct link to Reasons for Melting" title="Direct link to Reasons for Melting">​</a></h2>
<p>It&#x27;s important to keep in mind that a CAT&#x27;s TAIL (and nothing else) decides the rules for melting, <em>if</em> it allows melting at all. For example, our <a href="#single">single-issuance TAIL</a> only works with a specific coin, so it does not allow melting. CATs that use this TAIL can never be melted, no matter how small their face value.</p>
<p>Our delegated TAIL leaves it entirely up to the CAT&#x27;s creator how and when melting can happen. There are many possible reasons you may want to melt a CAT, other than the obvious example of its face value being less than the melt value.</p>
<p>Beyond our pre-packaged examples, TAILs with a wide range of functionality are also possible. To illustrate some of this functionality, let&#x27;s consider three potential reasons for melting, along with who is permitted to melt the tokens.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="removal-from-circulation">Removal From Circulation<a href="#removal-from-circulation" class="hash-link" aria-label="Direct link to Removal From Circulation" title="Direct link to Removal From Circulation">​</a></h3>
<p>For certain categories of CATs, such as stablecoins and redemption tokens, melting will be allowed only by the creator, and only if they own the tokens. In the case of a stablecoin, the creator may need to remove some tokens from circulation if backing funds are reduced. For redemption tokens, the owner may exchange a token with the creator for something of value. The token no longer has any face value, so its creator will remove it from circulation.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="value-exchange">Value Exchange<a href="#value-exchange" class="hash-link" aria-label="Direct link to Value Exchange" title="Direct link to Value Exchange">​</a></h3>
<p>Some CATs might allow their owners to melt tokens in order to gain something else of value, for example NFTs or other CATs. In fact, an entire marketplace could emerge from this concept.</p>
<p>Here are some possible examples of this:</p>
<ul>
<li>The creator of a set of NFTs also creates a small issuance of golden tickets that can be used to pick out any individual NFT before the set is made publicly available.</li>
<li>A celebrity issues some tokens that can be exchanged for something of non-monetary value, such as a meeting with said celebrity.</li>
<li>The holder of a CAT must submit a proof of melt in order to enter a contest.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ephemeral-tokens">Ephemeral Tokens<a href="#ephemeral-tokens" class="hash-link" aria-label="Direct link to Ephemeral Tokens" title="Direct link to Ephemeral Tokens">​</a></h3>
<p>A CAT could be created as a limited-time offer or as a game of musical chairs. In these cases, tokens would be melted <em>against the owner&#x27;s will</em>. This could be done either at random or as a deliberate type of slashing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="truth-table">Truth Table<a href="#truth-table" class="hash-link" aria-label="Direct link to Truth Table" title="Direct link to Truth Table">​</a></h2>
<p>The following is a list of <a href="#truths">truths</a> that are passed into the <a href="#tail">TAIL</a>:</p>
<table><thead><tr><th>Truth</th><th>Description</th></tr></thead><tbody><tr><td>My ID</td><td>The ID of the coin.</td></tr><tr><td>My Parent&#x27;s ID</td><td>The ID of the coin&#x27;s parent.</td></tr><tr><td>My Full Puzzle Hash</td><td>The puzzle hash contained inside the coin.</td></tr><tr><td>My Amount</td><td>The amount of the coin in mojos.</td></tr><tr><td>My Inner Puzzle Hash</td><td>The puzzle hash of the inner puzzle inside the CAT layer.</td></tr><tr><td>My Lineage Proof (optional)</td><td>Proof that the CAT&#x27;s parent has the same TAIL.</td></tr><tr><td>My TAIL Solution (optional)</td><td>A list of parameters passed into the TAIL program.</td></tr><tr><td>My Coin Info</td><td>The parent, puzzle hash, and amount.</td></tr><tr><td>CAT Mod Hash</td><td>The hash of the CAT before anything is curried.</td></tr><tr><td>CAT Mod Hash Hash</td><td>The hash of the CAT mod hash.</td></tr><tr><td>CAT TAIL Program Hash</td><td>The hash of the TAIL program that was curried into the CAT.</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>CATs are a great way to create tokens that represent divisible assets or currencies on top of the Chia blockchain. They can be used to represent stablecoins, tickets, store credit, and many other things.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Chia-Network/chialisp-web/blob/main/docs/primitives/cats.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/singletons/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Singletons</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/nfts/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">NFTs</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#code-examples" class="table-of-contents__link toc-highlight">Code Examples</a><ul><li><a href="#chia-blockchain" class="table-of-contents__link toc-highlight">chia-blockchain</a></li><li><a href="#chia-rs" class="table-of-contents__link toc-highlight">chia-rs</a></li><li><a href="#chia-wallet-lib" class="table-of-contents__link toc-highlight">chia-wallet-lib</a></li></ul></li><li><a href="#code" class="table-of-contents__link toc-highlight">CAT Code</a><ul><li><a href="#single" class="table-of-contents__link toc-highlight">Single-Issuance TAIL</a></li><li><a href="#multi" class="table-of-contents__link toc-highlight">Multi-Issuance TAIL</a></li></ul></li><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a></li><li><a href="#design-decisions" class="table-of-contents__link toc-highlight">Design Decisions</a></li><li><a href="#accounting" class="table-of-contents__link toc-highlight">Spend Accounting</a></li><li><a href="#extra-delta" class="table-of-contents__link toc-highlight">Extra Delta</a></li><li><a href="#tail" class="table-of-contents__link toc-highlight">TAIL Program</a></li><li><a href="#tail-limitations" class="table-of-contents__link toc-highlight">Limitations of the TAIL</a></li><li><a href="#valuation" class="table-of-contents__link toc-highlight">Valuation</a></li><li><a href="#reasons-for-melting" class="table-of-contents__link toc-highlight">Reasons for Melting</a><ul><li><a href="#removal-from-circulation" class="table-of-contents__link toc-highlight">Removal From Circulation</a></li><li><a href="#value-exchange" class="table-of-contents__link toc-highlight">Value Exchange</a></li><li><a href="#ephemeral-tokens" class="table-of-contents__link toc-highlight">Ephemeral Tokens</a></li></ul></li><li><a href="#truth-table" class="table-of-contents__link toc-highlight">Truth Table</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/operators/">Operators</a></li><li class="footer__item"><a class="footer__link-item" href="/clvm/">CLVM</a></li><li class="footer__item"><a href="https://docs.chia.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chia Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/chia" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/chia_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.chia.net/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/Chia-Network/clvm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">© 2024 Chia Network Inc., Licensed under the <a href="https://github.com/Chia-Network/chialisp-web/blob/main/LICENSE" target="_blank">Apache License, Version 2.0</a> | <a href="https://www.chia.net/terms">Terms</a></div></div></div></footer></div>
</body>
</html>