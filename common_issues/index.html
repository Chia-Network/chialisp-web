<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-common_issues" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.0">
<title data-rh="true">Common Issues | Chialisp</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chialisp.com/common_issues/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Common Issues | Chialisp"><meta data-rh="true" name="description" content="This page contains a list of the most common issues you may encounter when developing applications in Chialisp. This list is by no means comprehensive, and we recommend putting each of your applications through a rigorous code review and audit before deploying them on mainnet. However, by following the guidelines laid out here, you will avoid some common pitfalls that can be easy to overlook."><meta data-rh="true" property="og:description" content="This page contains a list of the most common issues you may encounter when developing applications in Chialisp. This list is by no means comprehensive, and we recommend putting each of your applications through a rigorous code review and audit before deploying them on mainnet. However, by following the guidelines laid out here, you will avoid some common pitfalls that can be easy to overlook."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chialisp.com/common_issues/"><link data-rh="true" rel="alternate" href="https://chialisp.com/common_issues/" hreflang="en"><link data-rh="true" rel="alternate" href="https://chialisp.com/common_issues/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Common Issues","item":"https://chialisp.com/common_issues"}]}</script><script src="/js/matomo.js" async defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.429b5699.css">
<script src="/assets/js/runtime~main.ba1e010c.js" defer="defer"></script>
<script src="/assets/js/main.c5b6e7b5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Chialisp</b></a><a href="https://docs.chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia Docs<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://docs.chia.net/academy-home/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia Academy<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia.net<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://github.com/Chia-Network/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/chialisp-primer/">Chialisp Primer</a><button aria-label="Expand sidebar category &#x27;Chialisp Primer&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/chialisp-concepts/">Chialisp Concepts</a><button aria-label="Expand sidebar category &#x27;Chialisp Concepts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/commands/">Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/syntax/">Syntax</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/modern-chialisp/">Modern Chialisp</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operators/">Operators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/examples/">Examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/costs/">Costs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/conditions/">Conditions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/optimization/">Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/common_issues/">Common Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/debugging/">Debugging</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/standard-transactions/">Primitives</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/clvm/">CLVM</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Common Issues</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Common Issues</h1></header><p>This page contains a list of the most common issues you may encounter when developing applications in Chialisp. This list is by no means comprehensive, and we recommend putting each of your applications through a rigorous code review and audit before deploying them on mainnet. However, by following the guidelines laid out here, you will avoid some common pitfalls that can be easy to overlook.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="password-coin">Password Coin<a href="#password-coin" class="hash-link" aria-label="Direct link to Password Coin" title="Direct link to Password Coin">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem">Problem<a href="#problem" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h3>
<p>Coins that are <em>only</em> locked with a password are not secure.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cause">Cause<a href="#cause" class="hash-link" aria-label="Direct link to Cause" title="Direct link to Cause">​</a></h3>
<p>Farmers can see and modify coin solutions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h3>
<p>A simple password coin would use this as its primary function:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(if (= (sha256 password) PASSWORD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (x)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre></div></div>
<p>Keep in mind that each node has its own mempool. When a farmer creates a new block, they can:</p>
<ul>
<li>Choose to include or exclude any spend from the mempool</li>
<li>View each coin spend and solution in the mempool</li>
<li>Modify any of the coin solutions (provided that the modified solution is valid)</li>
</ul>
<p>Let&#x27;s say a coin has been secured using only the above <code>if</code> statement. <code>PASSWORD_HASH</code> has been curried into the coin, so it cannot be modified. Therefore, in order for this coin to be spent, the solution must contain the original <code>password</code>, which must hash to <code>PASSWORD_HASH</code>. The solution will also contain <code>conditions</code>. This is a list of any Chialisp condition(s), one of which will presumably create a new coin to a puzzlehash the owner controls.</p>
<p>The problem with this puzzle is that whoever farms the coin will see the <code>password</code>, which is required to be included in the solution. The farmer could then ignore the original solution and spend the coin with new <code>conditions</code> that would create a new coin using a puzzlehash the farmer controls. In other words, the farmer could steal this coin as it was being spent.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-avoid">How to avoid<a href="#how-to-avoid" class="hash-link" aria-label="Direct link to How to avoid" title="Direct link to How to avoid">​</a></h3>
<p>Password coins are easy to create, so they are often used in training materials (see <a href="/chialisp-first-smart-coin/#password-puzzle">our documentation</a> for more info). However, coins locked with a password (and nothing else) are not secure. Instead, use announcements and the <code>AGG_SIG_ME</code> condition to secure your coins, as explained in the <a href="/standard-transactions/">standard transaction puzzle</a>.</p>
<p>Also keep in mind that a farmer can attempt to modify a coin&#x27;s solution as it is being spent. If modifying any of the conditions from your coin&#x27;s solution would result in the solution remaining valid, then you should assume the farmer will do exactly this.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="unchecked-hashing">Unchecked Hashing<a href="#unchecked-hashing" class="hash-link" aria-label="Direct link to Unchecked Hashing" title="Direct link to Unchecked Hashing">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-1">Problem<a href="#problem-1" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h3>
<p>Hash collisions could be used to modify coin values.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cause-1">Cause<a href="#cause-1" class="hash-link" aria-label="Direct link to Cause" title="Direct link to Cause">​</a></h3>
<p>Concatenating and hashing without verifying the length of items to be concatenated.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-1">Example<a href="#example-1" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h3>
<p>The CAT1 standard calculated coin IDs like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">coin ID = sha256(parent coin ID + puzzlehash + amount)</span><br></span></code></pre></div></div>
<p>This normally resulted in a correct <code>coin ID</code>, but the length of each component was never checked. An attacker therefore could shift the divider between the <code>puzzlehash</code> and the <code>amount</code> to the left by one or two bytes. Depending on the value of the extra byte(s), there was a 50% chance that this would result in an inflated value for the coin, and a 50% chance that the coin&#x27;s value would be negative. In the latter case the current coin could not be modified, but the attacker could simply spend it and try again.</p>
<p>The <code>puzzlehash</code> would be shortened by one or two bytes, and the <code>amount</code> would be lengthened by one or two bytes, but the resulting hash would be identical. Every coin using the CAT1 standard was vulnerable to this attack.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-avoid-1">How to avoid<a href="#how-to-avoid-1" class="hash-link" aria-label="Direct link to How to avoid" title="Direct link to How to avoid">​</a></h3>
<p>In the specific case of calculating a coin&#x27;s ID, you are recommended to use the new <a href="https://github.com/Chia-Network/chips/blob/main/CHIPs/chip-0011.md#coinid" target="_blank" rel="noopener noreferrer">coinid</a> operator, introduced in CHIP-11. This operator validates the length of each component of the coin&#x27;s ID, as well as the coin&#x27;s value. In addition the CLVM cost of this operator is lower than that of using <code>sha256</code> (800 versus 953), so there is no reason not to use it when calculating a coin&#x27;s ID.</p>
<p>For use cases that involve hashing a concatenated string to do something <em>other than</em> calculate a coin&#x27;s ID, you will need to use <code>sha256</code>. In these cases, prior to running the <code>sha256</code> command, be sure to validate that the length of each component is correct.</p>
<p>In the case of CAT1, the vulnerability was discovered prior to the existence of the <code>coinid</code> operator. Therefore, <code>sha256</code> was still required in the patch, which called the following function to calculate a coin&#x27;s ID:</p>
<div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun calculate_coin_id (parent puzzlehash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (if (all (size_b32 parent) (size_b32 puzzlehash) (&gt; amount -1))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (sha256 parent puzzlehash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (x)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre></div></div>
<p>This function verifies that the <code>parent coin ID</code> and <code>puzzlehash</code> are each 32 bytes, and that the <code>amount</code> is at least zero (negative value coins are not allowed). With this function call in place, if an attacker attempts to shift any of the components, the Chialisp program will exit and raise an exception.</p>
<p>For more information, see our <a href="https://www.chia.net/2022/07/29/cat1-vulnerability-explained-cve-and-cwe/" target="_blank" rel="noopener noreferrer">blog post discussing this issue</a>.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="unprotected-announcements">Unprotected Announcements<a href="#unprotected-announcements" class="hash-link" aria-label="Direct link to Unprotected Announcements" title="Direct link to Unprotected Announcements">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-2">Problem<a href="#problem-2" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h3>
<p>Multiple coins can assert the same announcement.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cause-2">Cause<a href="#cause-2" class="hash-link" aria-label="Direct link to Cause" title="Direct link to Cause">​</a></h3>
<p>Creating a coin announcement that does not include the ID of the coin being spent. This allows multiple coin spends to assert the same announcement, resulting in a replay attack.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-2">Example<a href="#example-2" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h3>
<p>TibetSwap v1 was an AMM that stored liquidity for coin pairs in a singleton with a liquidity TAIL. Upon spending this coin, a <code>CREATE_COIN_ANNOUNCEMENT</code> condition was created. This coin used a keyword of either &quot;mint&quot; or &quot;burn&quot; (and nothing else) as its announcement. In this case, an attacker could burn the same liquidity twice by asserting the same coin announcement twice. This attack could be repeated until all funds were drained.</p>
<p>The <a href="https://github.com/Yakuhito/tibet/blob/ee9223e8fa91a3258ea972dd7401f5b59f69323e/clsp/liquidity_tail.clsp#L46C39-L46C39" target="_blank" rel="noopener noreferrer">original liquidity TAIL with the vulnerability</a> is available in GitHub&#x27;s history.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-avoid-2">How to avoid<a href="#how-to-avoid-2" class="hash-link" aria-label="Direct link to How to avoid" title="Direct link to How to avoid">​</a></h3>
<p>Whenever you create a coin that uses a <code>CREATE_COIN_ANNOUNCEMENT</code> condition, remember that the condition can be asserted multiple times in the same block when the coin is being spent.</p>
<p>You can prevent this replay attack by including the ID of the coin being spent in the announcement, as can be found in the <a href="https://github.com/Yakuhito/tibet/blob/b37c51f38dbdd5f4426ac4fa55c76fcef0f522d0/clsp/liquidity_tail.clsp#L55C22-L55C22" target="_blank" rel="noopener noreferrer">patched version of the liquidity TAIL</a> used in <a href="https://v2.tibetswap.io/" target="_blank" rel="noopener noreferrer">TibetSwap v2</a>. In this case, the <code>singleton_coin_id</code> is included with the <code>CREATE_COIN_ANNOUNCEMENT</code> condition, which prevents the announcement from being asserted multiple times. TibetSwap v2 has been running since May 2023 without incident.</p>
<p>For more information about the vulnerability, how it was discovered, and how it was patched, see the <a href="https://blog.kuhi.to/tibetswap-v1-post-mortem" target="_blank" rel="noopener noreferrer">postmortem</a>.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="unprotected-solution">Unprotected Solution<a href="#unprotected-solution" class="hash-link" aria-label="Direct link to Unprotected Solution" title="Direct link to Unprotected Solution">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-3">Problem<a href="#problem-3" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h3>
<p>Anyone is free to change the solution provided in the spend bundle in any way they want that still satisfies the puzzle.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-avoid-3">How to avoid<a href="#how-to-avoid-3" class="hash-link" aria-label="Direct link to How to avoid" title="Direct link to How to avoid">​</a></h3>
<p>Ensure that all elements of the solution are either signed, or in some other way protected, so that only the desired spend is possible.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="replace-by-fee">Replace By Fee<a href="#replace-by-fee" class="hash-link" aria-label="Direct link to Replace By Fee" title="Direct link to Replace By Fee">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature-description">Feature description<a href="#feature-description" class="hash-link" aria-label="Direct link to Feature description" title="Direct link to Feature description">​</a></h3>
<p>&quot;Replace by Fee&quot; (RBF) is a technique that allows a new spend bundle to be added to the mempool that replaces an existing spend bundle. The rule is that all of the coins in the first spend bundle must exist in the replacement spend bundle, and that the fee attached to the new spend bundle must be greater than that in the original. In general, this is a very useful feature. For example, TibetSwap uses this feature to enable multiple swaps of a single pair in a single transaction block.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-4">Problem<a href="#problem-4" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h3>
<p>An attacker can &quot;piggyback&quot; some coin spends of their own on top of your spend bundle by resubmitting it with a greater fee. The solutions for the coins in the original spend bundle may be different in the replacement spend bundle, depending on how they were protected. And new coin spends can be introduced in the replacement spend bundle.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-avoid-4">How to avoid<a href="#how-to-avoid-4" class="hash-link" aria-label="Direct link to How to avoid" title="Direct link to How to avoid">​</a></h3>
<p>As stated above, ensure that if an attacker attempts to modify the solution to your spend bundle, the transaction will fail.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="flash-loans">Flash Loans<a href="#flash-loans" class="hash-link" aria-label="Direct link to Flash Loans" title="Direct link to Flash Loans">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="description">Description<a href="#description" class="hash-link" aria-label="Direct link to Description" title="Direct link to Description">​</a></h3>
<p>Ephemeral coins are created and spent in the same block. Because these coins are immediately spent, there is no output value, which means that the input can be any arbitrary amount.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-5">Problem<a href="#problem-5" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h3>
<p>Within a spend bundle, it is valid to create a coin of any XCH value, as long as the total XCH value of the unspent coins created in the spend bundle is less than or equal to the total XCH value of the spent coins. This is known as a &quot;flash loan,&quot; and it leaves unprotected coins vulnerable to being attacked.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-avoid-5">How to avoid<a href="#how-to-avoid-5" class="hash-link" aria-label="Direct link to How to avoid" title="Direct link to How to avoid">​</a></h3>
<p>Ensure that if an ephemeral coin is added to your spend bundle, such as with the aforementioned RBF spend, the coin(s) you are attempting to spend cannot be stolen or spent in a nefarious way. Always assume an attacker will attempt to modify your solution and/or add an ephemeral spend, and protect your coin spends accordingly.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="puzzles-containing-assert_coin_announcement">Puzzles containing <code>ASSERT_COIN_ANNOUNCEMENT</code><a href="#puzzles-containing-assert_coin_announcement" class="hash-link" aria-label="Direct link to puzzles-containing-assert_coin_announcement" title="Direct link to puzzles-containing-assert_coin_announcement">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-6">Problem<a href="#problem-6" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h3>
<p>If an <code>ASSERT_COIN_ANNOUNCEMENT</code> condition is used in a coin&#x27;s puzzle, the coin will be bricked (unable to be spent) if the coin being asserted has already been spent.</p>
<p>For example, say <code>coin A</code> uses this condition in its puzzle, and it asserts a coin announcement from <code>coin B</code>. In this case, <code>coin A</code> requires <code>coin B</code> to be spent in the same block as it is spent. If <code>coin B</code> is spent before <code>coin A</code>, then <code>coin A</code> can never be spent.</p>
<p>In addition, if <code>ASSERT_PUZZLE_ANNOUNCEMENT</code> is used in a coin&#x27;s puzzle, a coin with the same puzzle must be spent in the same block. This assertion is less risky because it only relies on a coin with a specific puzzle, and many such coins might exist.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-avoid-6">How to avoid<a href="#how-to-avoid-6" class="hash-link" aria-label="Direct link to How to avoid" title="Direct link to How to avoid">​</a></h3>
<p>Only use <code>ASSERT_COIN_ANNOUNCEMENT</code> and <code>ASSERT_PUZZLE_ANNOUNCEMENT</code> in a puzzle&#x27;s solution, and not in the puzzle itself. If one of these conditions are used in the solution for <code>coin A</code>, and <code>coin B</code> has already been spent, then <code>coin A</code> can still be spent later, albeit with a different solution.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spend-bundle-splitting">Spend Bundle Splitting<a href="#spend-bundle-splitting" class="hash-link" aria-label="Direct link to Spend Bundle Splitting" title="Direct link to Spend Bundle Splitting">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-7">Problem<a href="#problem-7" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h3>
<p>Spend bundles are not signed. So unless all of the coin spends in a spend bundle are linked together, the spend bundle can be split such that only part of the spend bundle is executed as submitted. The resulting smaller spend bundle can then be submitted, possibly with additional coin spends replacing the portion of the original spend bundle that was dropped.</p>
<p>Note that Replace By Fee cannot be used for spend bundle splitting. The spend bundle must be split before it gets to the mempool, or by a malicious node that splits it before gossiping it, or by a malicious farmer when farming the block that will include the spend bundle. A malicious node that splits a spend bundle before gossiping it will set up a race condition: each peer node will only accept one version of the spend bundle or the other, depending on which version it receives first.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-avoid-7">How to avoid<a href="#how-to-avoid-7" class="hash-link" aria-label="Direct link to How to avoid" title="Direct link to How to avoid">​</a></h3>
<p>If your spend bundle would be vulnerable to being split in a malicious way, you can link all coin spends together with <a href="/conditions/#assert-coin-announcement">announcements</a>. This will ensure that the spend bundle must remain intact when spent.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="signature-replay--signature-subtraction">Signature Replay / Signature Subtraction<a href="#signature-replay--signature-subtraction" class="hash-link" aria-label="Direct link to Signature Replay / Signature Subtraction" title="Direct link to Signature Replay / Signature Subtraction">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-8">Problem<a href="#problem-8" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h3>
<p>Replay attacks on signatures are possible if a malicious farmer can find a way to isolate a useful signature.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cause-3">Cause<a href="#cause-3" class="hash-link" aria-label="Direct link to Cause" title="Direct link to Cause">​</a></h3>
<p>All of the BLS signatures in a spend bundle are aggregated by arithmetically adding them together. Therefore, if a malicious farmer sees one aggregated signature that includes messages <code>A</code>, <code>B</code> and <code>C</code> signed with public keys <code>A&#x27;</code>, <code>B&#x27;</code> and <code>C&#x27;</code>, and then subsequently sees a spend bundle with an aggregated signature that includes messages <code>B</code> and <code>C</code>, with public keys <code>B&#x27;</code> and <code>C&#x27;</code>, then the farmer can subtract the latter aggregated signature from the former and derive the signature of message <code>A</code> with public key <code>A&#x27;</code>. The malicious farmer can then attempt to use that derived signature to initiate spends with a key they don&#x27;t have.</p>
<p>Other scenarios where signature subtraction could be possible include:</p>
<ul>
<li>Given signatures <code>A</code> and <code>A+B</code>, a malicious party could calculate the signature for <code>B</code></li>
<li>Given signatures <code>A+B</code>, <code>B+C</code>, and <code>A+C</code>, a malicious party could calculate the signatures for <code>A</code>, <code>B</code>, and <code>C</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-3">Example<a href="#example-3" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h3>
<p>In a one-sided Offer, an asset is given in exchange for nothing. This can be a valuable technique, for example when air-dropping NFTs to unknown addresses. However, if the Offer maker&#x27;s signature is accidentally revealed (in addition to the aggregated signature, which is always revealed), a malicious party could acquire <code>A</code> and <code>A+B</code>, as outlined above.</p>
<p>In this case, the malicious party could potentially receive the NFT; the honest Offer taker would pay the transaction fee.</p>
<p>In theory, individual signatures are not revealed to the broader network (only aggregated signatures must be revealed). However, signatures are not treated as private information. Some reasons a wallet may accidentally reveal an individual signature include:</p>
<ol>
<li>A coin spend is submitted, but the fee is too low and the transaction is evicted from the mempool</li>
<li>A re-org causes a spent coin to reappear as unspent</li>
<li>Replace By Fee (RBF) is used on a coin spend in the mempool</li>
</ol>
<p>In each of these cases, a wallet&#x27;s attempt to spend a coin is unsuccessful. Even if the wallet waits a long time before attempting to spend the same coin again, it should assume that at least one node has maintained a copy of the original signature.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-avoid-8">How to avoid<a href="#how-to-avoid-8" class="hash-link" aria-label="Direct link to How to avoid" title="Direct link to How to avoid">​</a></h3>
<p>Presume that all signatures are public. In cases where coins are only secured with signatures (and not with announcements), after an individual coin&#x27;s signature has been revealed, the wallet should be careful never to submit an identical signature again.</p>
<p>One hypothetical way for the wallet to accomplish this would be to keep track of every signature it has ever published, as well as each aggregate that would be unsafe to publish. This would be impractical; the reference wallet does not attempt to do it.</p>
<p>Instead, the recommended method for preventing signature subtraction is to secure all coin spends with announcements. For example, in the case of a one-sided Offer, this could be accomplished by requesting 1 mojo from the taker. The Offer will then include an announcement, thereby making it secure. In other words, the safest way to secure a one-sided Offer is to make it two-sided.</p>
<p>Another technique for preventing signature subtraction is to add a nonce to each spend bundle. If the nonce is generated correctly and consistently, the same spend bundle will never be signed twice, thus preventing the possibility of signature subtraction.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Chia-Network/chialisp-web/blob/main/docs/common_issues.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/optimization/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Optimization</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/debugging/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Debugging</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#password-coin" class="table-of-contents__link toc-highlight">Password Coin</a><ul><li><a href="#problem" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#cause" class="table-of-contents__link toc-highlight">Cause</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#how-to-avoid" class="table-of-contents__link toc-highlight">How to avoid</a></li></ul></li><li><a href="#unchecked-hashing" class="table-of-contents__link toc-highlight">Unchecked Hashing</a><ul><li><a href="#problem-1" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#cause-1" class="table-of-contents__link toc-highlight">Cause</a></li><li><a href="#example-1" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#how-to-avoid-1" class="table-of-contents__link toc-highlight">How to avoid</a></li></ul></li><li><a href="#unprotected-announcements" class="table-of-contents__link toc-highlight">Unprotected Announcements</a><ul><li><a href="#problem-2" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#cause-2" class="table-of-contents__link toc-highlight">Cause</a></li><li><a href="#example-2" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#how-to-avoid-2" class="table-of-contents__link toc-highlight">How to avoid</a></li></ul></li><li><a href="#unprotected-solution" class="table-of-contents__link toc-highlight">Unprotected Solution</a><ul><li><a href="#problem-3" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#how-to-avoid-3" class="table-of-contents__link toc-highlight">How to avoid</a></li></ul></li><li><a href="#replace-by-fee" class="table-of-contents__link toc-highlight">Replace By Fee</a><ul><li><a href="#feature-description" class="table-of-contents__link toc-highlight">Feature description</a></li><li><a href="#problem-4" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#how-to-avoid-4" class="table-of-contents__link toc-highlight">How to avoid</a></li></ul></li><li><a href="#flash-loans" class="table-of-contents__link toc-highlight">Flash Loans</a><ul><li><a href="#description" class="table-of-contents__link toc-highlight">Description</a></li><li><a href="#problem-5" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#how-to-avoid-5" class="table-of-contents__link toc-highlight">How to avoid</a></li></ul></li><li><a href="#puzzles-containing-assert_coin_announcement" class="table-of-contents__link toc-highlight">Puzzles containing <code>ASSERT_COIN_ANNOUNCEMENT</code></a><ul><li><a href="#problem-6" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#how-to-avoid-6" class="table-of-contents__link toc-highlight">How to avoid</a></li></ul></li><li><a href="#spend-bundle-splitting" class="table-of-contents__link toc-highlight">Spend Bundle Splitting</a><ul><li><a href="#problem-7" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#how-to-avoid-7" class="table-of-contents__link toc-highlight">How to avoid</a></li></ul></li><li><a href="#signature-replay--signature-subtraction" class="table-of-contents__link toc-highlight">Signature Replay / Signature Subtraction</a><ul><li><a href="#problem-8" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#cause-3" class="table-of-contents__link toc-highlight">Cause</a></li><li><a href="#example-3" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#how-to-avoid-8" class="table-of-contents__link toc-highlight">How to avoid</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/operators/">Operators</a></li><li class="footer__item"><a class="footer__link-item" href="/clvm/">CLVM</a></li><li class="footer__item"><a href="https://docs.chia.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chia Docs<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/chia" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/chia_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.chia.net/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/Chia-Network/clvm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">© 2025 Chia Network Inc., Licensed under the <a href="https://github.com/Chia-Network/chialisp-web/blob/main/LICENSE" target="_blank">Apache License, Version 2.0</a> | <a href="https://www.chia.net/terms">Terms</a></div></div></div></footer></div>
</body>
</html>