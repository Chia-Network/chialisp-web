<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-common_functions">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H6XZNYRS4V"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-H6XZNYRS4V",{anonymize_ip:!0})</script><title data-rh="true">Common Functions and Design Patterns | Chialisp</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chialisp.com/docs/common_functions"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Common Functions and Design Patterns | Chialisp"><meta data-rh="true" name="description" content="When you start to write full smart coins, you will start to realize that you will need certain common functionality in a lot of puzzles."><meta data-rh="true" property="og:description" content="When you start to write full smart coins, you will start to realize that you will need certain common functionality in a lot of puzzles."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chialisp.com/docs/common_functions"><link data-rh="true" rel="alternate" href="https://chialisp.com/docs/common_functions" hreflang="en"><link data-rh="true" rel="alternate" href="https://chialisp.com/docs/common_functions" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.cfe880d8.css">
<link rel="preload" href="/assets/js/runtime~main.6807e419.js" as="script">
<link rel="preload" href="/assets/js/main.26158e32.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Chialisp</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia.net<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/Chia-Network/chialisp-web" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/getting_started/intro_to_chialisp">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/">Chialisp</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/">Language Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/common_functions">Common Functions and Design Patterns</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/coins_spends_and_wallets">Coins, Spends and Wallets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/coin_lifecycle">Lifecycle of a Coin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/security">Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/debugging">Debugging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/optimization">Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/standard_transaction">The Standard Transaction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/puzzles/singletons">Standard Puzzles</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/tutorials/why_chia_is_great">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/clvm/basics">CLVM</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/glossary">Glossary</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/resources">Resources</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Chialisp</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Common Functions and Design Patterns</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Common Functions and Design Patterns</h1></header><p>When you start to write full smart coins, you will start to realize that you will need certain common functionality in a lot of puzzles.
Let&#x27;s go over how to include them and what some of them are:</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sha256tree">sha256tree<a class="hash-link" href="#sha256tree" title="Direct link to heading">​</a></h2><p>When puzzles are hashed, they are not simply serialized and passed to sha256.
Instead, we take the <em>tree hash</em> of the puzzle.</p><p>Recall that every clvm program can be represented as a binary tree.
Every object is either an atom (a leaf of the tree) or a cons box (a branch of the tree).
When we hash the puzzle, we start at the leaves of the tree and hash our way up, concatenating either a 1 or a 2 to denote that it&#x27;s either an atom or a cons box.
Once a cons box is hashed, it becomes a new leaf to be hashed into its parent cons box and the process recurses.
Here&#x27;s what that looks like in Chialisp:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun sha256tree</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (if (l TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (sha256 2 (sha256tree (f TREE)) (sha256tree (r TREE)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (sha256 1 TREE)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It is extremely useful to calculate tree hashes within a Chialisp puzzle.
You can assert puzzles of other coins, condense puzzles for easier signing, and make CREATE_COIN conditions that are dependent on some passed-in data.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="currying">Currying<a class="hash-link" href="#currying" title="Direct link to heading">​</a></h2><p><em>Currying</em> is named in honor of the mathematician Haskell Curry. In math, currying is the technique of converting a function that takes multiple arguments into a sequence of functions that each take a single argument. For more information on the mathematical concept of currying, see <a href="https://en.wikipedia.org/wiki/Currying" target="_blank" rel="noopener noreferrer" title="Currying in math">Wikipedia</a>.</p><p>In Chialisp, currying is a technique of pre-committing a portion of the solution to a puzzle. It works like hard-coding, but it&#x27;s more versatile because it allows for the same puzzle to be reused. </p><p>For example, if a puzzle requires a password in its solution, a Chialisp developer could hard-code the password into the puzzle. But what if the developer later wanted to create a new smart coin with a different password? He or she would have to make a copy of the puzzle and swap out all instances of the old password for the new one. This would be quite inconvenient, especially in a puzzle with a complex solution.</p><p>The developer could avoid this inconvenience by using a variable for the password. But that wouldn&#x27;t be secure -- a farmer could change the password and steal the coin. This is where currying comes in -- it allows the developer to pre-commit without hard-coding.</p><p>Currying is an extremely important concept in Chialisp that is responsible for almost the entirety of how the state is stored in coins.
The idea is to pass in arguments to a puzzle <em>before</em> it is hashed.
When you curry, you commit to solution values so that the individual solving the puzzle cannot change them.
Let&#x27;s take a look at how this is implemented in Chialisp:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; curry.clvm</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> ;; utility function used by curry</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (defun fix_curry_args (items core)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (if items</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (qq (c (q . (unquote (f items))) (unquote (fix_curry_args (r items) core))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> core</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> ; (curry sum (list 50 60)) =&gt; returns a function that is like (sum 50 60 ...)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (defun curry (func list_of_args) (qq (a (q . (unquote func)) (unquote (fix_curry_args list_of_args (q . 1))))))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The reason this is so useful is that you may want to create the blueprint of a puzzle but use different values for certain parameters every time you create it.
You can&#x27;t rely on the puzzle solver to honestly and correctly pass in the information you want to use, so you need to make sure it is passed in before they ever get the chance to solve it.</p><p>The above function may look complex, but all it&#x27;s really doing is wrapping the function in an <code>a</code> and prepending the arguments to <code>1</code>, which (when compiled to clvm) will refer to the rest of the puzzle arguments.
Absent of all the quotes, the above code reduces to something like this:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(a func (c curry_arg_1 (c curry_arg_2 1)))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can also do the reverse operation.
Given a program, you can <em>uncurry</em> the list of arguments with a simple <code>(f (r (r )))</code>:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(f (r (r curried_func)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; (c curry_arg_1 (c curry_arg_2 1))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s take our password locked coin example from earlier, this time as a Chialisp puzzle:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (password new_puzhash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (defconstant CREATE_COIN 51)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (defun check_password (password new_puzhash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (if (= (sha256 password) (q . 0x2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (list (list CREATE_COIN new_puzhash amount))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (x)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> ; main</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (check_password password new_puzhash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can see that the password hash is baked into the source of the puzzle.
This means that every time you want to lock up a coin with a new password, you have to recreate the file containing the code&#x27;s source.
It would be much nicer if we fully generalized it:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; password_coin.clvm</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (PASSWORD_HASH password new_puzhash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (defconstant CREATE_COIN 51)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (defun check_password (PASSWORD_HASH password new_puzhash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (if (= (sha256 password) PASSWORD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (list (list CREATE_COIN new_puzhash amount))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (x)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> ; main</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (check_password PASSWORD_HASH password new_puzhash amount)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, now we have the problem that anyone can pass in whatever password/hash combo that they please and unlock this coin.
When we create this coin, we need the password hash to be committed to. Before determining the puzzle hash of the coin we&#x27;re going to create, we need to curry in the hash with something like this:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; curry_password_coin.clvm</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (password_hash password_coin_mod)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (include &quot;curry.clvm&quot;)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (curry password_coin_mod (list password_hash))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we compile this function and pass it parameters like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">brun &lt;curry_password_coin mod&gt; &#x27;((q . 0xcafef00d) (q . &lt;password_coin mod&gt;))&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will receive a puzzle that looks very similar to our password coin module but has been expanded to include the hash we passed in.
You can now run the currying mod above with a different password hash, and it will output a new puzzle every time.
We can then hash that puzzle and create a coin with the returned puzzle hash.</p><p>Note that this required that we run the currying module using <code>brun</code> in our own environment off-chain in order to create the puzzle we would lock up our coin with.
A lot of the time, this currying will happen in python, or whatever wrapper language is being used by the software creating the coins.
However, there are some use cases in which we would want to use currying within the scope of a puzzle.
Let&#x27;s look at one now.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="outer-and-inner-puzzles">Outer and Inner puzzles<a class="hash-link" href="#outer-and-inner-puzzles" title="Direct link to heading">​</a></h2><p>A common design pattern, and one of the most powerful features of Chialisp, is the ability to have an outer puzzle that &quot;wraps&quot; an inner puzzle.
This concept is extremely handy because it allows a coin to retain all of its standard functionality and programmability within the inner puzzle but be bound to an extra set of rules by the outer puzzle.</p><p>For this example, we&#x27;re going to continue with our password locking, but this time we&#x27;re going to require that every time the coin is spent, it requires a new password to be set.
Let&#x27;s look at all the code, and then we&#x27;ll break it down:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> MOD_HASH ;; curried in</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> PASSWORD_HASH ;; curried in</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> INNER_PUZZLE ;; curried in</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> inner_solution</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> password</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> new_password_hash</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (include &quot;condition_codes.clvm&quot;)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (include &quot;sha256tree.clvm&quot;)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (include &quot;curry-and-treehash.clvm&quot;)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (defun pw-puzzle-hash (MOD_HASH mod_hash_hash new_password_hash_hash inner_puzzle_hash)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (puzzle-hash-of-curried-function</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> MOD_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> inner_puzzle_hash new_password_hash_hash mod_hash_hash ; parameters must be passed in reverse order</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> ;; tweak `CREATE_COIN` condition by wrapping the puzzle hash, forcing it to be a password locked coin</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (defun-inline morph-condition (condition new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (if (= (f condition) CREATE_COIN)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (list CREATE_COIN</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (pw-puzzle-hash MOD_HASH (sha256tree MOD_HASH) (sha256tree new_password_hash) (f (r condition)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (f (r (r condition)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> condition</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> ;; tweak all `CREATE_COIN` conditions, enforcing created coins to be locked by passwords</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (defun morph-conditions (conditions new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (if conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (c</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (morph-condition (f conditions) new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (morph-conditions (r conditions) new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> ()</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> ; main</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (if (= (sha256 password) PASSWORD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (morph-conditions (a INNER_PUZZLE inner_solution) new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (x &quot;wrong password&quot;)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You may notice that we imported a new library called <code>curry-and-treehash</code>.
We&#x27;ll talk about that in a few steps.</p><p>First, let&#x27;s talk about the arguments.
When you create this puzzle for the first time, you need to curry in 3 things: <code>MOD_HASH</code>, which is the tree hash of this code with no curried arguments, <code>PASSWORD_HASH</code>, which is the hash of the password that will unlock this coin, and <code>INNER_PUZZLE</code> which is a completely separate puzzle that will have its own rules about how the coin can be spent.</p><p>Chialisp puzzles have the tendency to be read from the bottom up, so let&#x27;s start with this chunk:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">; main</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(if (= (sha256 password) PASSWORD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (morph-conditions (a INNER_PUZZLE inner_solution) new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (x &quot;wrong password&quot;)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>All that&#x27;s happening here is that we&#x27;re making sure the password is correct and, if it is, we&#x27;re going to run the curried in <code>INNER_PUZZLE</code> with the passed in <code>inner_solution</code>.
This will return a list of conditions that we will pass to the next function along with the new password hash and <code>MOD_HASH</code>.</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;; tweak all `CREATE_COIN` conditions, enforcing created coins to be locked by passwords</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun morph-conditions (conditions new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (if conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (c</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (morph-condition (f conditions) new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (morph-conditions (r conditions) new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> ()</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Recursion is the foundation of Chialisp and functions like these very commonly show up when writing it.
In order to iterate through the list of conditions, we first check if there are still items left (remember that an empty list <code>()</code> or <strong>nil</strong> evaluates to false). Then, we morph the first condition and concatenate it with the recursive output of the rest of the list.
In the end, we will have the same list of items in the same order, but all of them will have passed thru <code>morph-condition</code>.</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">;; tweak `CREATE_COIN` condition by wrapping the puzzle hash, forcing it to be a password locked coin</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun-inline morph-condition (condition new_password_hash MOD_HASH)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (if (= (f condition) CREATE_COIN)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (list CREATE_COIN</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (pw-puzzle-hash MOD_HASH (sha256tree MOD_HASH) (sha256tree new_password_hash) (f (r condition)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (f (r (r condition)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> condition</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This function is also pretty simple. We&#x27;re first checking if the opcode (first item in the list) is CREATE_COIN.
If it&#x27;s not, just return the condition as usual.
If it is, return a condition that is almost exactly the same, except we&#x27;re passing the puzzle hash into a function that will modify it:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun pw-puzzle-hash (MOD_HASH mod_hash_hash new_password_hash_hash inner_puzzle_hash</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> (puzzle-hash-of-curried-function</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> MOD_HASH</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> inner_puzzle_hash new_password_hash_hash mod_hash_hash ; parameters must be passed in reverse order</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is where the exciting stuff happens.
Since we don&#x27;t know the inner puzzle, only it&#x27;s hash, it&#x27;s impossible to curry it directly into the next puzzle we want to create.
Furthermore, if we don&#x27;t want to pass in the whole source of this current module every time that we spend it, we don&#x27;t have a puzzle to curry things into either.</p><p>However, all we care about is generating the correct <em>puzzle hash</em> for the next puzzle, and we do have the tree hashes for both this module and the inner puzzle.
We can use <code>puzzle-hash-of-curried-function</code> which allows us to create the puzzle hash of a function given: a) the puzzle hash of that function and b) the puzzle hashes of all of its arguments in reverse order <em>as though they were a part of a tree hash</em>. This means that arguments that are atoms and numbers are expected to be in tree hash form, with a 1 prefix like <code>(sha256 (q . 1) my-argument-value)</code> and the output of <code>sha256tree</code> is suitable for anything involving cons cells. It would be possible for <code>puzzle-hash-of-curried-function</code> to guess these if it took the parameter values themselves but that might require recomputation of expensive hashes.</p><p>Other implementation details of this library are a bit much to go into in this part of the tutorial, but, in essence, it allows us to <em>resume</em> a tree hash that we have completed except for the last step.</p><p>And that&#x27;s it! When this coin is created, it can only be spent by a password that hashes to the curried in PASSWORD_HASH.
The inner puzzle can be anything that you want, including other outer puzzles that have their own inner puzzles.
Whatever coins get created as a result of that inner puzzle will be &quot;wrapped&quot; by this same outer puzzle, ensuring that every child of this coin is locked by a password <em>forever</em>.</p><p>We created a simple coin, but you can see the potential of this. You can enforce a set of rules not only on a coin that you lock up but on <em>every</em> descendant coin.
Not only that, the rules can be enforced <em>on top of other smart coins</em>.
In the Chialisp ecosystem, all smart coins are interoperable with each other unless otherwise specified by one of the puzzles in the stack. The possibilities are endless and represent the vast programmability that Chialisp enables for coins.</p><p>In the next section, we&#x27;ll talk about the standard transaction format on the Chia network.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Chia-Network/chialisp-web/edit/main/docs/common_functions.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Language Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/coins_spends_and_wallets"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Coins, Spends and Wallets</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#sha256tree" class="table-of-contents__link toc-highlight">sha256tree</a></li><li><a href="#currying" class="table-of-contents__link toc-highlight">Currying</a></li><li><a href="#outer-and-inner-puzzles" class="table-of-contents__link toc-highlight">Outer and Inner puzzles</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/ref/clvm">CLVM Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://developers.chia.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chia Developers Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://keybase.io/team/chia_network.public" target="_blank" rel="noopener noreferrer" class="footer__link-item">Keybase<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/chia_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.chia.net/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/Chia-Network/clvm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">© 2022 Chia Network Inc., Licensed under the <a href="https://github.com/Chia-Network/chialisp-web/blob/main/LICENSE" target="_blank">Apache License, Version 2.0</a> | <a href="https://www.chia.net/terms">Terms</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.6807e419.js"></script>
<script src="/assets/js/main.26158e32.js"></script>
</body>
</html>