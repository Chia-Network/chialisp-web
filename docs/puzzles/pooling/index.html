<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.2">
<title data-react-helmet="true">Pooling | Chialisp</title><meta data-react-helmet="true" property="og:url" content="https://chialisp.com/docs/puzzles/pooling"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Pooling | Chialisp"><meta data-react-helmet="true" name="description" content="The way that Chia Network does pooling is unlike many blockchains that have come before it. Pool operators actually rely on an on-chain smart coin to verify that they will be able to directly claim any potential pool rewards that farmers create."><meta data-react-helmet="true" property="og:description" content="The way that Chia Network does pooling is unlike many blockchains that have come before it. Pool operators actually rely on an on-chain smart coin to verify that they will be able to directly claim any potential pool rewards that farmers create."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://chialisp.com/docs/puzzles/pooling"><link data-react-helmet="true" rel="alternate" href="https://chialisp.com/docs/puzzles/pooling" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://chialisp.com/docs/puzzles/pooling" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ba3c1805.css">
<link rel="preload" href="/assets/js/runtime~main.e6adfe12.js" as="script">
<link rel="preload" href="/assets/js/main.86eba72b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Chialisp</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://chialisp.com/training" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Training<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Chia.net<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/Chia-Network/chialisp-web" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle displayOnlyInLargeViewport_cxYs react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Chialisp</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="https://chialisp.com/training" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Training<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="menu__list-item"><a href="https://chia.net" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Chia.net<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="menu__list-item"><a href="https://github.com/Chia-Network/chialisp-web" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu menu--responsive thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_iZzd" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Chialisp</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">1 - CLVM Basics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/coins_spends_and_wallets">2 - Coins, Spends and Wallets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/deeper_into_clvm">3 - Deeper into CLVM</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/high_level_lang">4 - The High Level Language, Compiler, and Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/common_functions">5 - Common Functions in Chialisp</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/standard_transaction">6 - The Standard Transaction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/coin_lifecycle">7 - Lifecycle of a Coin</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security">8 - Security</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/debugging">9 - Debugging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/optimization">10 - Optimization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/glossary">The Great Chia Glossary</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CLVM</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ref/clvm">CLVM Reference</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ref/serialization">Serialization</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Puzzles</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/puzzles/singletons">Singletons</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/puzzles/pooling">Pooling</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/puzzles/cats">Chia Asset Tokens (CATs)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/puzzles/offers">Offers</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/why_chia_is_great">Why Chia is Great</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/developing_applications">An Overview of Developing Applications on Chia</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/tools_and_setup">Tools and Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/programming_chialisp">Programming in Chialisp</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/coin_lifecycle_and_testing">Coin Lifecycle and Testing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/singletons">Singletons and Ethereum-like Contracts in Chia</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/high-level-tips-1">High Level Tips - Managing State, Coin Creation, Announcements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/high-level-tips-2">High Level Tips - Security, Checking Arguments &amp; Signatures</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/high-level-tips-3">High Level Tips - Announcements, Oracles</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/custom_puzzle_lock">Lock a coin with a custom puzzle</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/coin_spend_rpc">Spend a coin using RPC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/structure_of_a_chia_application">Structure of a Chia Application</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/CAT_Launch_Process_Linux_MacOS">CAT creation tutorial (Linux/MacOS)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/CAT_Launch_Process_Windows">CAT creation tutorial (Windows)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/single_issuance_CAT">Single Issuance CAT</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/multiple_issuance_CAT">Multiple Issuance CAT</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/offers_gui_tutorial">Offers - GUI Tutorial</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/offers_cli_tutorial">Offers - CLI Tutorial</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">FAQ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/faq">ChiaLisp and CLVM FAQ</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="markdown"><header><h1 class="h1Heading_dC7a">Pooling</h1></header><p>The way that Chia Network does pooling is unlike many blockchains that have come before it. Pool operators actually rely on an on-chain smart coin to verify that they will be able to directly claim any potential pool rewards that farmers create.
This allows pools to trust farmers enough to pay them out, while still keeping the power of making the blocks in the hands of the farmer.
This means that the decentralization of the network remains the same, even as the rewards get concentrated to the pool!</p><p>In this section, we&#x27;re going to break down how all of this works in Chialisp.
This section assumes you have already read the section about <a href="https://chialisp.com/docs/puzzles/singletons" target="_blank" rel="noopener noreferrer">singletons</a> (or at least understand how they work) as that is the outer puzzle that wraps the pooling puzzles.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-requirements"></a>Design Requirements<a class="hash-link" href="#design-requirements" title="Direct link to heading">#</a></h2><p>There are a few requirements that were set for how the pooling protocol would work on the Chia Network. Let&#x27;s go over them now:</p><ul><li><strong>The farmer farms the blocks, not the pool.</strong> This is incredibly important for network decentralization. If this is not true, then the bigger a pool gets, the closer it is to gaining 51% of the network resources.
We still want the farmers to create the blocks, but we need some way to assure the pool that the farmer will give them the reward when they do.
We do this by creating plots that farm directly to a specific puzzle hash, and ensuring that puzzle hash is something that the pool can claim.</li><li><strong>The farmer must be able to change pools.</strong> Initially, this seems to conflict with the first requirement.
Plots can be made to send rewards directly to a puzzle hash, but you cannot change that puzzle hash once they are plotted.
If you want to switch pools, you&#x27;ll have to remake all of your plots! We solve this by having our plots create payments that a specific singleton (also called a &quot;plot nft&quot;) can claim.
Then, we can lend partial control of that singleton to a pool, but still retain the ability to reclaim our singleton and lend it instead to a different pool.
Our plots will remain effective as long as we retain control of the singleton.</li><li><strong>The farmer cannot leave the pool immediately.</strong> This requirement prevents attacks common to other blockchains where a miner will send partials to a pool until they win a block, then leave the pool immediately and claim that block for themselves.
To prevent this, we have implemented something called a <strong>waiting room</strong> puzzle which is nearly the same as the puzzle for farming to a pool, except that the farmer can reclaim their singleton after a specified amount of time (in blocks).</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="the-pool-member"></a>The Pool Member<a class="hash-link" href="#the-pool-member" title="Direct link to heading">#</a></h2><p>We call the standard puzzle that we use to lend away partial control of our singleton the <strong>pool member</strong> inner puzzle.
Our goal here is threefold:</p><ul><li>Allow the pool to claim <a href="https://chialisp.com/docs/puzzles/singletons#pay-to-singleton" target="_blank" rel="noopener noreferrer">pay-to-singleton coins</a></li><li>Disallow the farmer from claiming any coins</li><li>Allow the farmer to begin the process of reclaiming full control of the singleton</li></ul><p>Let&#x27;s take a look at the full source now:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI chialisp"><pre tabindex="0" class="prism-code language-chialisp codeBlock_rtdJ thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       POOL_PUZZLE_HASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       P2_SINGLETON_PUZZLE_HASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       OWNER_PUBKEY</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       POOL_REWARD_PREFIX</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       WAITINGROOM_PUZHASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       Truths</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       p1</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">       pool_reward_height</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">     )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; POOL_PUZZLE_HASH is commitment to the pool&#x27;s puzzle hash</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; P2_SINGLETON_PUZZLE_HASH is the puzzle hash for your pay to singleton puzzle</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; OWNER_PUBKEY is the farmer pubkey which authorises a travel</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; POOL_REWARD_PREFIX is network-specific data (mainnet vs testnet) that helps determine if a coin is a pool reward</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; WAITINGROOM_PUZHASH is the puzzle_hash you&#x27;ll go to when you iniate the leaving process</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; Absorbing money if pool_reward_height is an atom</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; Escaping if pool_reward_height is ()</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; p1 is pool_reward_amount if absorbing money</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; p1 is key_value_list if escaping</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; pool_reward_amount is the value of the coin reward - this is passed in so that this puzzle will still work after halvenings</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; pool_reward_height is the block height that the reward was generated at. This is used to calculate the coin ID.</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; key_value_list is signed extra data that the wallet may want to publicly announce for syncing purposes</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (include condition_codes.clib)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (include singleton_truths.clib)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; takes a lisp tree and returns the hash of it</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun sha256tree (TREE)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (if (l TREE)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (sha256 2 (sha256tree (f TREE)) (sha256tree (r TREE)))</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (sha256 1 TREE)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun-inline calculate_pool_reward (pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX pool_reward_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (sha256 (logior POOL_REWARD_PREFIX (logand (- (lsh (q . 1) (q . 128)) (q . 1)) pool_reward_height)) P2_SINGLETON_PUZZLE_HASH pool_reward_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun absorb_pool_reward (POOL_PUZZLE_HASH my_inner_puzzle_hash my_amount pool_reward_amount pool_reward_id)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (list</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN my_inner_puzzle_hash my_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN POOL_PUZZLE_HASH pool_reward_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_PUZZLE_ANNOUNCEMENT pool_reward_id)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list ASSERT_COIN_ANNOUNCEMENT (sha256 pool_reward_id &#x27;$&#x27;))</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun-inline travel_to_waitingroom (OWNER_PUBKEY WAITINGROOM_PUZHASH my_amount extra_data)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (list (list AGG_SIG_ME OWNER_PUBKEY (sha256tree extra_data))</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (list CREATE_COIN WAITINGROOM_PUZHASH my_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; main</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (if pool_reward_height</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (absorb_pool_reward POOL_PUZZLE_HASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (my_inner_puzzle_hash_truth Truths)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (my_amount_truth Truths)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        p1</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (calculate_pool_reward pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX p1)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (travel_to_waitingroom OWNER_PUBKEY WAITINGROOM_PUZHASH (my_amount_truth Truths) p1)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As always, let&#x27;s begin with the arguments:</p><p><code>POOL_PUZZLE_HASH</code> is the address to which we want to pay the pool when we win a block reward.
The pool uses this to verify that the singleton has been lent to them.</p><p><code>P2_SINGLETON_PUZZLE_HASH</code> is the puzzle hash that payments to this singleton will have.
This is the hash that farmers make their plots to.</p><p><code>OWNER_PUBKEY</code> is the public key that will sign the decision to leave the pool.
This is likely owned by the farmer.</p><p><code>POOL_REWARD_PREFIX</code> is a bit of a unique argument.
On the chia mainnet, this will always be <code>ccd5bb71183532bff220ba46c268991a00000000000000000000000000000000</code>.
It is the beginning of the <code>parent_coin_id</code> of pool reward coins. Because those coins do not have a parent, their ID is derived from a combination of the network ID in the left half of the ID, and an incrementing identifier in the right.
That first half is followed by 32 zeroes to make it the length of a standard hash.
We&#x27;ll talk more about why this is needed when we go over the segment of code that uses it.</p><p><code>WAITINGROOM_PUZHASH</code> is the puzzle hash of the waiting room puzzle that we will go to when we attempt to leave the pool.
We will go over that puzzle later, but what&#x27;s important to know is that we commit to the puzzle we leave to before we join the pool.
This is so the pool can have certain assurances about how long it will take you to leave.</p><p><code>Truths</code> is the data structure that is forcefully added to this puzzle as part of the singleton top layer.
It contains some data we will use in the puzzle which we will access by using some functions from the <code>singleton_truths.clib</code> library.</p><p>There are two spend cases for this puzzle.
The <strong>absorb case</strong> will most likely be triggered by the pool and is how they claim the rewards that the farmers receive.
The <strong>escape case</strong> will be initiated by the farmer to begin the process of leaving the pool by heading to the waiting room.
The following two arguments change depending on the case we are executing:</p><p><code>p1</code> is named the way it is because it is going to be different depending on the spend type we are using.
It is either:</p><ul><li>The amount of the pool reward that is being claimed (1750000000000 during the first three years)</li><li>A list of key value pairs that is used to reveal important information to the blockchain for wallets to use (similar to the <a href="https://chialisp.com/docs/puzzles/singletons#the-launcher" target="_blank" rel="noopener noreferrer">singleton launcher</a>)</li></ul><p><code>pool_reward_height</code> is also different depending on the spend case, but in the escape case it is just <code>()</code> so we leave it named the way it is.
In the absorb case, it is the height of the pool reward that is being absorbed.
This is used along with <code>POOL_REWARD_PREFIX</code> to calculate the <code>parent_coin_id</code> of the reward coin so that we can calculate its ID.</p><p>Let&#x27;s talk about our main entry point:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI chialisp"><pre tabindex="0" class="prism-code language-chialisp codeBlock_rtdJ thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(if pool_reward_height</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (absorb_pool_reward POOL_PUZZLE_HASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                      (my_inner_puzzle_hash_truth Truths)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                      (my_amount_truth Truths)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                      p1</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                      (calculate_pool_reward pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX p1)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (travel_to_waitingroom OWNER_PUBKEY WAITINGROOM_PUZHASH (my_amount_truth Truths) p1)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The main control flow here is whether or not the height is passed in as <code>()</code>. This is how we determine the spend type to execute. After that we just head to the appropriate function that generates the conditions we will need for the type of spend we are executing. You&#x27;ll notice that we are extracting the relevant data from the <code>Truths</code> object before we pass them to the inner functions.</p><p>We are also calculating one additional piece of information.
Let&#x27;s look at it now:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI chialisp"><pre tabindex="0" class="prism-code language-chialisp codeBlock_rtdJ thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun-inline calculate_pool_reward (pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX pool_reward_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (sha256 (logior POOL_REWARD_PREFIX (logand (- (lsh (q . 1) (q . 128)) (q . 1)) pool_reward_height)) P2_SINGLETON_PUZZLE_HASH pool_reward_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This line may look complex, but it&#x27;s doing something fairly simplistic.
It is calculating the coin ID of the reward coin it is claiming by manually calculating the parent id from the <code>POOL_REWARD_PREFIX</code> and <code>pool_reward_height</code>.</p><p>Why do we have to do this? The manual calculation is due to the fact that this singleton may have other payments made to it.
Right now, since we are lending our singleton to the pool, we don&#x27;t want the singleton to be able to claim those rewards. We specifically only want the pool to be able to claim pool rewards that are generated from farming.
Since we know these rewards have a <code>parent_coin_id</code> that is a <a href="https://chialisp.com/docs/coin_lifecycle#farming-rewards" target="_blank" rel="noopener noreferrer">special format</a>, we can manually calculate it to ensure that the pool can&#x27;t lie to us and pass in the ID of a non-reward coin.</p><p>Let&#x27;s take a look at this section here:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI chialisp"><pre tabindex="0" class="prism-code language-chialisp codeBlock_rtdJ thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(logior POOL_REWARD_PREFIX (logand (- (lsh (q . 1) (q . 128)) (q . 1)) pool_reward_height))</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>(- (lsh (q . 1) (q . 128)) (q . 1))</code> is simply a way of generating a sequence of 32 <code>f</code>s. We then use <code>logand</code> on that with the pool reward height, which in an honest scenario should leave it unchanged.
Finally, we use <code>logior</code> to combine the two values into one string.
Let&#x27;s say we have a height of <code>abcdef</code>.
Our final product will be <code>ccd5bb71183532bff220ba46c268991a00000000000000000000000000abcdef</code>.</p><p>Why do we need this extra <code>logand</code> with the string of <code>f</code>s?  It&#x27;s to prevent a relatively obscure, but possible attack.
Remember that an attacker can pass whatever they want in through the solution.
For example, a 32 byte hex string.
If they passed through the right hex string, they could completely control the output of our calculation <em>except</em> for the bits that happen to be set to 1 in the genesis challenge half of the <code>POOL_REWARD_PREFIX</code> (62/128 of them).
The idea is that a pool could grind out a coin whose parent ID has all of those bits set, create the coin, and then use the singleton to claim it.
Why claim a coin that you already had control of? This will become more apparent in the waiting room puzzle, but they could hypothetically &quot;freeze&quot; the singleton in their pool if they were able to reset the puzzle.
It&#x27;s not as important in the pool member puzzle, but it is still probably best to prevent the pool from spending the singleton in an unintended way.
The <code>logand</code> ensures that only bits on the right can change, every bit on left gets set to 0 before it is evaluated with the <code>logior</code>.</p><p>Okay let&#x27;s move onto the conditions for the absorb spend case:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI chialisp"><pre tabindex="0" class="prism-code language-chialisp codeBlock_rtdJ thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun absorb_pool_reward (POOL_PUZZLE_HASH my_inner_puzzle_hash my_amount pool_reward_amount pool_reward_id)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (list</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (list CREATE_COIN my_inner_puzzle_hash my_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (list CREATE_COIN POOL_PUZZLE_HASH pool_reward_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (list CREATE_PUZZLE_ANNOUNCEMENT pool_reward_id)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (list ASSERT_COIN_ANNOUNCEMENT (sha256 pool_reward_id &#x27;$&#x27;))</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The first <code>CREATE_COIN</code> condition ensures that our singleton is recreated exactly as it is. Remember that we get <code>my_inner_puzzle_hash</code> and <code>my_amount</code> from our singleton outer puzzle, so we don&#x27;t need to assert them.</p><p>The next <code>CREATE_COIN</code> condition creates the coin that uses the excess value from spending the pay-to-singleton coin to pay the pool.
Keep in mind that this puzzle hash is curried into the puzzle and cannot change.
This is because there is no signature required from the pool to spend the coin.
If we didn&#x27;t pre-commit to the puzzle hash, anyone could solve with their own puzzle hash and spend the rewards to themselves.</p><p>The announcement conditions are the other side of the <a href="https://chialisp.com/docs/puzzles/singletons#pay-to-singleton" target="_blank" rel="noopener noreferrer">pay-to-singleton announcements</a>. The announcement creation allows the pay-to-singleton to assert that it has received the instruction to pay out.
The announcement assertion ensures that the pay-to-singleton is actually spent (otherwise we run into the singleton &quot;freezing&quot; problem from above again).</p><p>Finally, let&#x27;s look at the escape conditions:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI chialisp"><pre tabindex="0" class="prism-code language-chialisp codeBlock_rtdJ thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun-inline travel_to_waitingroom (OWNER_PUBKEY WAITINGROOM_PUZHASH my_amount extra_data)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (list (list AGG_SIG_ME OWNER_PUBKEY (sha256tree extra_data))</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN WAITINGROOM_PUZHASH my_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Simple enough. We first require a signature on the key/value list that is being passed in through the solution to secure it and to signal that this spend is indeed triggered by the owner of the singleton. The only other thing we do is send ourselves to the waiting room.</p><p>Let&#x27;s talk about that puzzle now.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="the-waiting-room"></a>The Waiting Room<a class="hash-link" href="#the-waiting-room" title="Direct link to heading">#</a></h2><p>Before we start talking about this puzzle, let&#x27;s examine the full source as usual:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI chialisp"><pre tabindex="0" class="prism-code language-chialisp codeBlock_rtdJ thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod (</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        POOL_PUZZLE_HASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        P2_SINGLETON_PUZZLE_HASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        OWNER_PUBKEY</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        POOL_REWARD_PREFIX</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        RELATIVE_LOCK_HEIGHT</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        Truths</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        spend_type</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        p1</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        p2</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; POOL_PUZZLE_HASH is commitment to the pool&#x27;s puzzle hash</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; P2_SINGLETON_PUZZLE_HASH is the puzzlehash for your pay_to_singleton puzzle</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; OWNER_PUBKEY is the farmer pubkey which signs the exit puzzle_hash</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; POOL_REWARD_PREFIX is network-specific data (mainnet vs testnet) that helps determine if a coin is a pool reward</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; RELATIVE_LOCK_HEIGHT is how long it takes to leave</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; spend_type is: 0 for absorbing money, 1 to escape</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; if spend_type is 0</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; p1 is pool_reward_amount - the value of the coin reward - this is passed in so that this puzzle will still work after halvenings</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; p2 is pool_reward_height - the block height that the reward was generated at. This is used to calculate the coin ID.</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; if spend_type is 1</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; p1 is key_value_list - signed extra data that the wallet may want to publicly announce for syncing purposes</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; p2 is destination_puzhash - the location that the escape spend wants to create itself to</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (include condition_codes.clvm)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (include singleton_truths.clib)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; takes a lisp tree and returns the hash of it</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun sha256tree (TREE)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (if (l TREE)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (sha256 2 (sha256tree (f TREE)) (sha256tree (r TREE)))</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (sha256 1 TREE)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun-inline calculate_pool_reward (pool_reward_height P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX pool_reward_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (sha256 (logior POOL_REWARD_PREFIX (logand (- (lsh (q . 1) (q . 128)) (q . 1)) pool_reward_height)) P2_SINGLETON_PUZZLE_HASH pool_reward_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun absorb_pool_reward (POOL_PUZZLE_HASH my_inner_puzzle_hash my_amount pool_reward_amount pool_reward_id)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (list</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN my_inner_puzzle_hash my_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN POOL_PUZZLE_HASH pool_reward_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_PUZZLE_ANNOUNCEMENT pool_reward_id)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list ASSERT_COIN_ANNOUNCEMENT (sha256 pool_reward_id &#x27;$&#x27;))</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (defun-inline travel_spend (RELATIVE_LOCK_HEIGHT new_puzzle_hash my_amount extra_data)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (list (list ASSERT_HEIGHT_RELATIVE RELATIVE_LOCK_HEIGHT)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (list CREATE_COIN new_puzzle_hash my_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (list AGG_SIG_ME OWNER_PUBKEY (sha256tree (list new_puzzle_hash extra_data)))</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  ; main</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (if spend_type</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (travel_spend RELATIVE_LOCK_HEIGHT p2 (my_amount_truth Truths) p1)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (absorb_pool_reward POOL_PUZZLE_HASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (my_inner_puzzle_hash_truth Truths)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (my_amount_truth Truths)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        p1</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">                        (calculate_pool_reward p2 P2_SINGLETON_PUZZLE_HASH POOL_REWARD_PREFIX p1)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>You may notice that is looks nearly identical to the one above.
Instead of breaking this down piece by piece, we&#x27;re just going to focus on the differences.
First, the parameters:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI chialisp"><pre tabindex="0" class="prism-code language-chialisp codeBlock_rtdJ thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  POOL_PUZZLE_HASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  P2_SINGLETON_PUZZLE_HASH</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  OWNER_PUBKEY</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  POOL_REWARD_PREFIX</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  RELATIVE_LOCK_HEIGHT</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  Truths</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  spend_type</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  p1</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  p2</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We still have <code>POOL_PUZZLE_HASH</code>, <code>P2_SINGLETON_PUZZLE_HASH</code>, <code>OWNER_PUBKEY</code>, and <code>POOL_REWARD_PREFIX</code>.
However, now we also have a new curried in parameter called <code>RELATIVE_LOCK_HEIGHT</code>. This indicates the amount of time after entering this waiting room that we have to wait before we can spend away to something else.</p><p>Note that relative lock heights are calculated from the time of the coin&#x27;s creation.
If the coin is spent as part of an absorb, this lock height resets.
Theoretically, with a large enough lock height and a big enough farmer who wins frequently, this singleton can be &quot;frozen&quot; until the farmer is lucky enough not to win a block within the specified timeframe.</p><p>We still have <code>Truths</code>, since this is still a singleton inner puzzle.
However, the final three arguments are almost completely different.</p><p><code>spend_type</code> is now necessary because we can no longer choose which spend case we are executing based on the last argument.</p><p><code>p1</code> is different based on the spend type:</p><ul><li>If we&#x27;re doing the absorb spend, it&#x27;s the amount of the pool reward coin.</li><li>If we&#x27;re traveling to a new puzzle, it&#x27;s the key/value list that we use to record data in the blockchain.</li></ul><p><code>p2</code> is also different based on the spend type:</p><ul><li>If we&#x27;re doing the absorb spend, it&#x27;s the height at which the pool reward coin was created.</li><li>If we&#x27;re traveling to a new puzzle, it&#x27;s the puzzle hash of that puzzle</li></ul><p>After the argument differences, the only other major change is in the travel function:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI chialisp"><pre tabindex="0" class="prism-code language-chialisp codeBlock_rtdJ thin-scrollbar" style="color:#383a42;background-color:#fafafa;font-weight:bold"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun-inline travel_spend (RELATIVE_LOCK_HEIGHT new_puzzle_hash my_amount extra_data)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (list (list ASSERT_HEIGHT_RELATIVE RELATIVE_LOCK_HEIGHT)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list CREATE_COIN new_puzzle_hash my_amount)</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (list AGG_SIG_ME OWNER_PUBKEY (sha256tree (list new_puzzle_hash extra_data)))</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>First, we assert that the required amount of time has passed (this is for the pool&#x27;s safety).
Then, we create the new specified coin.
Note that we don&#x27;t get to choose the amount and, therefore, must escape to a new singleton.</p><p>Finally, we sign the extra data, just like before, but this time we include the <code>destination_puzhash</code> so that someone malicious cannot steal our singleton by substituting in a value.</p><p>Those are the only changes!</p><p>It may seem pretty irregular to have these as separate but similar puzzles.
There&#x27;s a lot of code duplication which is usually bad practice.
It&#x27;s very possible that there is a way to combine these two puzzles into a single puzzle, but the cost would increase dramatically.
At the end of the day, it&#x27;s better to have duplicated code than to bog down the blockchain with needlessly expensive transactions.</p><p>Interestingly enough, we actually want to be in the waiting room state with a lock height of zero when we are pooling by ourselves.
The reasoning is that since we are &quot;lending&quot; the singleton to ourselves, we don&#x27;t really need the insurance that we leave early, which is the entire point of the waiting room.
This cuts down on unnecessary spends, and saves us even more cost in the long run.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/Chia-Network/chialisp-web/edit/main/docs/puzzles/pooling.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_wj+Z"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/puzzles/singletons"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Singletons</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/puzzles/cats"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Chia Asset Tokens (CATs) Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#design-requirements" class="table-of-contents__link">Design Requirements</a></li><li><a href="#the-pool-member" class="table-of-contents__link">The Pool Member</a></li><li><a href="#the-waiting-room" class="table-of-contents__link">The Waiting Room</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">CLVM Basics</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/coins_spends_and_wallets/">Coins, Spends and Wallets</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://keybase.io/team/chia_network.public" target="_blank" rel="noopener noreferrer" class="footer__link-item">Keybase</a></li><li class="footer__item"><a href="https://twitter.com/chia_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://www.chia.net/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li><li class="footer__item"><a href="https://github.com/Chia-Network/clvm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_SRtH" href="/"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright">Â© 2022 Chia Network Inc. | <a href="https://chia.net/terms">Terms</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.e6adfe12.js"></script>
<script src="/assets/js/main.86eba72b.js"></script>
</body>
</html>