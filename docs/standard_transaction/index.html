<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-standard_transaction">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H6XZNYRS4V"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-H6XZNYRS4V",{anonymize_ip:!0})</script><title data-rh="true">The Standard Transaction | Chialisp</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chialisp.com/docs/standard_transaction"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="The Standard Transaction | Chialisp"><meta data-rh="true" name="description" content="You should now be well versed in a number of ways to lock up a coin using a Chialisp puzzle."><meta data-rh="true" property="og:description" content="You should now be well versed in a number of ways to lock up a coin using a Chialisp puzzle."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chialisp.com/docs/standard_transaction"><link data-rh="true" rel="alternate" href="https://chialisp.com/docs/standard_transaction" hreflang="en"><link data-rh="true" rel="alternate" href="https://chialisp.com/docs/standard_transaction" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.cfe880d8.css">
<link rel="preload" href="/assets/js/runtime~main.6807e419.js" as="script">
<link rel="preload" href="/assets/js/main.26158e32.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Chialisp</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia.net<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/Chia-Network/chialisp-web" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/getting_started/intro_to_chialisp">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/">Chialisp</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/">Language Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/common_functions">Common Functions and Design Patterns</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/coins_spends_and_wallets">Coins, Spends and Wallets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/coin_lifecycle">Lifecycle of a Coin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/security">Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/debugging">Debugging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/optimization">Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/standard_transaction">The Standard Transaction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/puzzles/singletons">Standard Puzzles</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/tutorials/why_chia_is_great">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/clvm/basics">CLVM</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/glossary">Glossary</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/resources">Resources</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Chialisp</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">The Standard Transaction</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>The Standard Transaction</h1></header><p>You should now be well versed in a number of ways to lock up a coin using a Chialisp puzzle.
We have all the tools we need now to talk about the standard transaction format on the Chia network.</p><p>Before you go through this section, it may be worth it to check out this <a href="https://www.chia.net/2021/05/27/Agrgregated-Sigs-Taproot-Graftroot.html" target="_blank" rel="noopener noreferrer">blog post</a> by Bram Cohen on why the standard transaction is the way it is.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pay-to-delegated-puzzle-or-hidden-puzzle">Pay to &quot;Delegated Puzzle&quot; or &quot;Hidden Puzzle&quot;<a class="hash-link" href="#pay-to-delegated-puzzle-or-hidden-puzzle" title="Direct link to heading">​</a></h2><p>If you remember from <a href="/docs/coins_spends_and_wallets">our discussion of coins, spends, and wallets</a> we created a puzzle that paid to a &quot;delegated puzzle&quot;: a puzzle that allows the solver to pass in a puzzle and solution to create their own conditions for the output.
This is one half of the functionality we want our standard transaction to have.</p><p>However, we also want the ability to pre-commit to a puzzle without revealing it, and let anybody with the knowledge of the &quot;hidden&quot; puzzle spend it.</p><p>But how do we pre-commit to this hidden puzzle?  We can curry it in, but if we perform the delegated spend case we will have to reveal the full puzzle including the curried in hidden puzzle and it will no longer be hidden.
We can&#x27;t lock up a coin with the same puzzle anymore, or else people will be able to tell that the puzzle hash is the same and spend it without our consent.
Our delegated spend might not even make it to the network; a malicious node can just deny our transaction after seeing it and then publish the hidden spend case on their own.</p><p>We can attempt to solve this by hashing the hidden puzzle.
This has some similar problems.
If you spend the hidden case even once, people can see any identical puzzle hashes later and spend them without your consent.
Furthermore, many people may try to use the same hidden puzzle.
If anyone reveals it, all coins locked up with that same puzzle can also be identified and spent.
We need the puzzle to be hidden, but also have some entropy that keeps it unique to us.</p><p>The solution that the standard transaction uses is to derive a new private key from a) the hidden puzzle and b) the public key that can sign for the delegated spend case:</p><p><code>synthetic_offset == sha256(original_public_key + hidden_puzzle_hash)</code></p><p>We then calculate the public key of this new private key, and add it to our existing original public key:</p><p><code>synthentic_public_key == original_public_key + synthetic_offset_pubkey</code></p><p>If the solver can correctly reveal BOTH the hidden puzzle and the original public key, then our puzzle can derive the synthetic public key and make sure that it matches the one that is curried in.</p><p>You may wonder why we add the public key from our derived private key to the original public key when it&#x27;s already part of the derivation.
This is because we use the synthetic public key to verify the signature of our delegated spends as well.
When you add two public keys, the sum of their private keys gives the private key for the resulting public key.
If we didn&#x27;t add the original public key then anyone who knew the hidden puzzle could derive the synthetic private key and could then perform delegated spends!  Adding the original public key ensures that there is still a secret component of the synthetic private key, even though half of it can be known.
This secret component is the private key for the original public key.</p><p>This technique is also neat because it allows us to hide the hidden puzzle in a piece of information that was already necessary for the delegated spend.
It&#x27;s impossible to guess what the hidden puzzle is, even if it&#x27;s a standard hidden puzzle!  It&#x27;s even hard to tell if there&#x27;s a hidden puzzle at all.
This can also contribute to privacy.
For example, if two parties agree to lock up some coins with a hidden puzzle together, you can share pubkeys and verify that information on the blockchain without revealing anything to the network.
Then, if you both agree that the coins <em>can</em> be spent with the hidden puzzle if either party is dishonest, you can trustlessly delegated spend the coins to the correct destinations and it&#x27;s impossible to tell that they are not just normal everyday spends.</p><p>We&#x27;ll look at the code in a moment, but here&#x27;s a few terms to know before you look at it:</p><ul><li><strong>hidden puzzle</strong>: a &quot;hidden puzzle&quot; that can be revealed and used as an alternate way to unlock the underlying funds</li><li><strong>synthetic key offset</strong>: a private key cryptographically generated using the hidden puzzle and <code>original_public_key</code> as inputs</li><li><strong>synthetic public key</strong>: the public key (curried in) that is the sum of <code>original_public_key</code> and the public key corresponding to <code>synthetic_key_offset</code></li><li><strong>original public key</strong>: a public key, where knowledge of the corresponding private key represents ownership of the coin</li><li><strong>delegated puzzle</strong>: a delegated puzzle, as in &quot;graftroot&quot;, which should return the desired conditions.</li><li><strong>solution</strong>: the solution to the delegated or hidden puzzle</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-chialisp">The Chialisp<a class="hash-link" href="#the-chialisp" title="Direct link to heading">​</a></h2><p>Here&#x27;s the full source and then we&#x27;ll break it down:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(mod</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle solution)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; &quot;assert&quot; is a macro that wraps repeated instances of &quot;if&quot;</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; usage: (assert A0 A1 ... An R)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; all of A0, A1, ... An must evaluate to non-null, or an exception is raised</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; return the last item (if we get that far)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defmacro assert items</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (if (r items)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            (list if (f items) (c assert (r items)) (q . (x)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">            (f items)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (include condition_codes.clvm)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (include sha256tree.clvm)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; &quot;is_hidden_puzzle_correct&quot; returns true iff the hidden puzzle is correctly encoded</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defun-inline is_hidden_puzzle_correct (SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (=</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          SYNTHETIC_PUBLIC_KEY</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (point_add</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              original_public_key</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              (pubkey_for_exp (sha256 original_public_key (sha256tree delegated_puzzle)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; &quot;possibly_prepend_aggsig&quot; is the main entry point</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (defun-inline possibly_prepend_aggsig (SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle conditions)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (if original_public_key</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (assert</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              (is_hidden_puzzle_correct SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">              conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (c (list AGG_SIG_ME SYNTHETIC_PUBLIC_KEY (sha256tree delegated_puzzle)) conditions)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    ; main entry point</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (possibly_prepend_aggsig</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">        (a delegated_puzzle solution))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That&#x27;s probably a lot to digest so let&#x27;s break it down piece by piece.
First, let&#x27;s talk about the arguments:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle solution)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>All of these terms are defined above.
When we solve this puzzle:</p><ul><li><code>SYNTHETIC_PUBLIC_KEY</code> is curried in</li><li>We pass in <code>original_public_key</code> if it&#x27;s the hidden spend or <code>()</code> if it&#x27;s the delegated spend</li><li><code>delegated_puzzle</code> is the hidden puzzle if it&#x27;s the hidden spend, or the delegated puzzle if it&#x27;s the delegated spend</li><li><code>solution</code> is the solution to whatever is passed into <code>delegated_puzzle</code></li></ul><p>As with most Chialisp programs, we&#x27;ll start looking at the implementation from the bottom:</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(possibly_prepend_aggsig</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">    (a delegated_puzzle solution))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There&#x27;s nothing much going on here, we&#x27;re mostly just passing arguments to <code>possibly_prepend_aggsig</code> to start the program.
The only thing to note is that we&#x27;re evaluating the delegated puzzle with the solution before passing it in.
This will result in a list of conditions that we will output as long as the rest of the puzzle checks out.</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun-inline possibly_prepend_aggsig (SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle conditions)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (if original_public_key</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (assert</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (is_hidden_puzzle_correct SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle) ; hidden case</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          conditions</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (c (list AGG_SIG_ME SYNTHETIC_PUBLIC_KEY (sha256tree delegated_puzzle)) conditions) ; delegated case</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This function is the main control flow logic that determines whether we&#x27;re doing the &quot;hidden&quot; or &quot;delegated&quot; spend.
The first line just checks if an <code>original_public_key</code> was passed in.
In the delegated spend, we pass <code>()</code> for that argument, and since that evaluates to false, it works great as a switch to determine what we&#x27;re doing.</p><p>If the spend is the hidden spend, we pass most of our parameters to <code>is_hidden_puzzle_correct</code> and, as long as it doesn&#x27;t fail, we just return whatever conditions are given to us.
If the spend is the delegated spend, we prepend a signature requirement from the curried in public key on the hash of the delegated puzzle.</p><div class="language-chialisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#383a42;--prism-background-color:#fafafa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-chialisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">(defun-inline is_hidden_puzzle_correct (SYNTHETIC_PUBLIC_KEY original_public_key delegated_puzzle)</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  (=</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      SYNTHETIC_PUBLIC_KEY</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      (point_add</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          original_public_key</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">          (pubkey_for_exp (sha256 original_public_key (sha256tree delegated_puzzle)))</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#383a42;font-weight:bold"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is the Chialisp representation of what was explained in the section above.
A private key is any 32 bytes so we&#x27;re going to use <code>sha256</code> (whose output is 32 bytes) to make sure our private key is derived from the <code>original_public_key</code> and the hash of the hidden puzzle.
We pass the resulting hash to <code>pubkey_for_exp</code> which turns our private key into a public key.
Then, we <code>point_add</code> this generated public key to our original pubkey to get our synthetic public key.
If it equals the curried in one, this function passes, otherwise it returns <code>()</code> and the <code>assert</code> from the previous function raises.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>This puzzle secures almost all of the coins on the Chia network.
When you use the Chia Network wallet software, it is crawling the blockchain looking for coins locked up with this specific format.
The <code>SYNTHETIC_PUBLIC_KEY</code> it is looking for is actually using a hidden puzzle of <code>(=)</code> which is obviously invalid and fails immediately.
This is because most users of Chia don&#x27;t need the hidden puzzle functionality for vanilla transactions.
But, by having the capabilities built in, it enables much cooler functionality later on.
This puzzle also makes for a fantastic inner puzzle of any smart coins you may write.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Chia-Network/chialisp-web/edit/main/docs/standard_transaction.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/optimization"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Optimization</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/puzzles/singletons"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Singletons</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#pay-to-delegated-puzzle-or-hidden-puzzle" class="table-of-contents__link toc-highlight">Pay to &quot;Delegated Puzzle&quot; or &quot;Hidden Puzzle&quot;</a></li><li><a href="#the-chialisp" class="table-of-contents__link toc-highlight">The Chialisp</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/ref/clvm">CLVM Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://developers.chia.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chia Developers Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://keybase.io/team/chia_network.public" target="_blank" rel="noopener noreferrer" class="footer__link-item">Keybase<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/chia_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.chia.net/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/Chia-Network/clvm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/full_logo_white.svg" alt="Chialisp full logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">© 2022 Chia Network Inc., Licensed under the <a href="https://github.com/Chia-Network/chialisp-web/blob/main/LICENSE" target="_blank">Apache License, Version 2.0</a> | <a href="https://www.chia.net/terms">Terms</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.6807e419.js"></script>
<script src="/assets/js/main.26158e32.js"></script>
</body>
</html>